<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALERTE MNU : Mission conformité</title>
    <style>
        :root {
            --primary: #e63946; /* Rouge Alerte */
            --secondary: #457b9d; /* Bleu Ministère */
            --light: #f1faee; /* Fond Clair */
            --dark: #1d3557; /* Bleu Foncé Texte */
            --success: #2a9d8f; /* Vert Succès */
            --warning: #e9c46a; /* Jaune Avertissement */
            --danger: #e76f51; /* Orange Danger */
            --gray: #6c757d; /* Gris */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary);
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative; /* Added for backdoor button positioning */
        }

        h1 {
             font-size: 1.8rem;
             margin-bottom: 5px;
        }
        header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        h2, h3 {
            margin-bottom: 15px;
            color: var(--dark);
        }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.2rem; }


        .timer-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px; /* Slightly reduced gap */
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            background-color: var(--dark);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: inline-block;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s;
            min-width: 100px; /* Ensure consistent width */
            text-align: center;
            flex-shrink: 0; /* Prevent timer shrinking */
        }

        .timer.warning {
            background-color: var(--warning);
            color: var(--dark);
        }

        .timer.danger {
            background-color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .stage {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none; /* Initially hidden */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .stage.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .intro { /* Keep intro visible initially */
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .btn {
            display: inline-block;
            background-color: var(--secondary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-decoration: none; /* Remove underline if used as link */
            text-align: center;
        }

        .btn:hover:not(:disabled) { /* Prevent hover effect when disabled */
            background-color: var(--dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:active:not(:disabled) { /* Prevent active effect when disabled */
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
         .btn:disabled {
             background-color: var(--gray);
             cursor: not-allowed;
             transform: none;
             box-shadow: 0 2px 4px rgba(0,0,0,0.05);
             opacity: 0.65; /* Indicate disabled state */
         }


        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-help { background-color: var(--gray); }

        .item-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .item {
            background-color: var(--light);
            border: 2px solid var(--secondary);
            border-radius: 5px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            width: calc(25% - 12px); /* Adjusted for gap */
            text-align: center;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Ensure content aligns well */
        }

        .item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .item.selected {
            border-color: var(--success);
            background-color: rgba(42, 157, 143, 0.1);
            box-shadow: 0 0 0 3px var(--success);
        }

        .item img {
            max-width: 80%; /* Adjust as needed */
            height: 50px; /* Fixed height */
            object-fit: contain; /* Maintain aspect ratio */
            margin: 0 auto 10px auto; /* Center image */
            border-radius: 3px;
        }
        .item p {
            font-size: 0.9rem;
        }

        .drop-zones {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }

        .drop-zone {
            border: 2px dashed var(--secondary);
            border-radius: 5px;
            padding: 20px;
            flex: 1;
            min-height: 200px;
            background-color: rgba(69, 123, 157, 0.05);
            transition: all 0.3s;
        }

        .drop-zone:hover {
            background-color: rgba(69, 123, 157, 0.1);
            border-color: var(--primary);
        }

        .drop-zone h3 {
            text-align: center;
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .dropped-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .dropped-item {
            background-color: var(--light);
            border: 1px solid var(--secondary);
            border-radius: 5px;
            padding: 8px 12px;
            width: calc(50% - 5px);
            text-align: center;
            font-size: 0.85rem;
            cursor: pointer; /* Indicate it's clickable */
            transition: background-color 0.2s;
        }
        .dropped-item:hover {
            background-color: rgba(230, 57, 70, 0.1); /* Light red */
        }


        .feedback {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none; /* Initially hidden */
            animation: fadeIn 0.5s;
            border-width: 1px;
            border-style: solid;
        }
         /* Style for clue text in feedback */
         .feedback .clue {
             font-size: 0.85rem;
             font-style: italic;
             color: var(--dark);
             opacity: 0.8;
             margin-top: 8px;
             display: block; /* Ensure it takes its own line */
         }


        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .feedback.success {
            background-color: rgba(42, 157, 143, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .feedback.error {
            background-color: rgba(231, 111, 81, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        .card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .card {
            background-color: white;
            border: 1px solid var(--gray);
            border-radius: 5px;
            padding: 15px;
            /* Ajustement pour Stage 3 : légèrement plus large */
            width: calc(33.333% - 10px);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            font-size: 0.95rem;
        }
        /* Spécifique pour les cartes de l'étape 3 disponibles */
        #available-logistics-steps .card {
            width: calc(50% - 8px); /* 2 par ligne pour plus de clarté */
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary);
        }

        /* Style pour les cartes sélectionnées dans Stage 2 & 4 */
        .card.selected {
            border-color: var(--success);
            background-color: rgba(42, 157, 143, 0.1);
            box-shadow: 0 0 0 2px var(--success);
        }

        /* Style pour les cartes sélectionnées dans Stage 2 & 4 */
        .card.selected::after {
            content: "✓";
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--success);
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* NOUVEAU: Style pour les cartes disponibles de l'Étape 3 qui sont dans la séquence */
        #available-logistics-steps .card.step-in-sequence {
            background-color: rgba(42, 157, 143, 0.1); /* Léger fond vert */
            border-color: var(--success);
            opacity: 0.7; /* Optionnel: Les rendre légèrement moins visibles */
            cursor: not-allowed; /* Indiquer qu'on ne peut pas recliquer dessus */
        }
        #available-logistics-steps .card.step-in-sequence:hover {
            /* Empêcher l'effet hover normal si la carte est déjà sélectionnée */
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }


        /* Styles pour la zone de séquence ordonnée (Stage 3) */
        .ordered-sequence-area {
             margin-top: 30px;
             background-color: #f8f9fa;
             padding: 20px;
             border-radius: 8px;
             border: 1px solid #eee;
        }
         #built-sequence-list {
             list-style-position: inside; /* Ensure OL numbers are inside */
             list-style-type: decimal; /* Explicitly set decimal numbering */
             border: 1px solid #ddd;
             padding: 15px 15px 5px 25px; /* Adjust left padding for numbers */
             border-radius: 5px;
             min-height: 50px;
             background-color: white; /* Fond blanc pour contraste */
             margin-bottom: 15px; /* Espace avant bouton 'clear' */
         }
         #built-sequence-list li {
             margin-bottom: 10px; /* Espace entre items */
             padding: 8px 10px;
             border-radius: 3px;
             cursor: pointer;
             transition: background-color 0.2s ease, border-color 0.2s ease;
             /* Ensure default marker styling is not overridden badly */
             display: list-item; /* Make sure it behaves like a list item */
             /* Default state - pas de couleur spécifique ici, mais on pourrait ajouter un style de base */
             background-color: var(--light); /* Utilisation d'une variable pour cohérence */
             border-left: 3px solid var(--secondary); /* Bordure bleue par défaut */
         }
         /* Conserve le style pour les éléments de la liste */
         #built-sequence-list li.step-selected {
            background-color: rgba(42, 157, 143, 0.15); /* Légèrement plus prononcé */
            border-left: 3px solid var(--success);
         }

         #built-sequence-list li:hover { /* Hover to remove */
             background-color: rgba(230, 57, 70, 0.1); /* Hover rouge léger */
             border-left-color: var(--danger); /* Indicate removal on hover */
         }
         #clear-sequence-btn {
             margin-top: 0; /* Enlevé le margin-top */
             font-size: 0.8rem;
             padding: 5px 10px;
         }

        /* SUPPRESSION des styles .map-container, .map-point, .map-line, .map-arrow */

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input[type="text"],
        .input-group textarea { /* Apply styles to textarea too */
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Ensure consistent font */
        }
        .input-group textarea {
            resize: vertical; /* Allow vertical resize */
            min-height: 60px; /* Minimum height */
        }

        .input-group input[type="text"]:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(69, 123, 157, 0.2);
        }

        /* Certificate Styles - Keep as is for capture */
        .certificate {
            background-color: #f8f9fa; /* Use non-transparent background for capture */
            border: 5px solid var(--success);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 30px auto 0 auto; /* Remove bottom margin for capture */
            max-width: 600px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            color: var(--dark); /* Ensure text color for capture */
        }
        /* Ensure colors are captured */
        .certificate h2 { color: var(--success); }
        .certificate #team-name-display-cert { color: var(--primary); }
        .certificate #time-remaining { color: var(--success); }
        .certificate #participants-section-cert h4 { color: var(--dark); }
        .certificate h3 { color: var(--dark); } /* Ensure Synthèse heading is dark */
        .certificate-seal { background-color: var(--success); color: white; }


        .certificate::before { /* Inner border */
            content: "";
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border: 2px dashed var(--success);
            border-radius: 5px;
            pointer-events: none;
        }

        .certificate h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }
        .certificate p {
             margin-bottom: 15px;
        }
        .certificate ul {
            list-style-position: inside;
            text-align: left;
            margin-top: 20px;
            padding-left: 20px; /* Indent list */
        }
         .certificate li {
             margin-bottom: 8px;
             font-size: 0.95rem;
         }
         /* Styles for Participants on Certificate */
         #participants-section-cert h4 {
             font-size: 1rem;
             margin-bottom: 5px;
         }
         #participant-list-cert {
             list-style: none !important;
             padding-left: 10px !important;
             margin-top: 0;
             font-style: italic;
         }
         #participant-list-cert li {
             margin-bottom: 3px;
             font-size: 0.9rem;
         }


        .certificate-seal {
            position: absolute;
            bottom: 25px;
            right: 25px;
            width: 90px; /* Larger seal */
            height: 90px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1rem;
            transform: rotate(-15deg);
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.2);
        }

        .hidden {
            display: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            padding: 30px 40px; /* More padding */
            width: 90%;
            max-width: 700px; /* Wider modal */
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--primary);
            text-align: center;
            margin-bottom: 25px;
        }
         .modal-content h3 {
            color: var(--secondary);
            margin-top: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
         }
         .modal-content p {
             font-size: 0.95rem;
             margin-bottom: 10px;
         }
        /* Style for code snippets in modal */
        .modal-content code {
            background-color: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
            color: var(--dark); /* Ensure readability */
        }


        .close {
            position: absolute; /* Position relative to modal-content */
            top: 15px;
            right: 20px;
            font-size: 2rem; /* Larger close button */
            line-height: 1;
            font-weight: bold;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s, transform 0.3s;
        }

        .close:hover {
            color: var(--primary);
            transform: rotate(90deg);
        }

        .progress-bar {
            height: 12px; /* Slightly thicker */
            background-color: #e9ecef;
            border-radius: 6px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.5s ease-in-out;
            border-radius: 6px;
        }

        .info-box {
            background-color: rgba(69, 123, 157, 0.05); /* Lighter blue */
            border-left: 5px solid var(--secondary);
            padding: 20px;
            margin: 25px 0;
            border-radius: 0 8px 8px 0;
             /* Add border styles that will be revealed */
             border-top: 1px solid #eee;
             border-bottom: 1px solid #eee;
             border-right: 1px solid #eee;
        }

        .info-box h3 {
            color: var(--secondary);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        /* Specific styling for legislative text */
         .info-box .leg-text {
            font-family: 'Courier New', Courier, monospace; /* Monospace for legal text maybe? Or keep default */
            font-size: 0.85rem;
            background-color: #ffffff; /* White background */
            border: 1px solid #eee;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            white-space: pre-wrap; /* Preserve line breaks from HTML */
            color: #333; /* Darker gray for text */
            display: block; /* Ensure it takes block space */
            max-height: 150px; /* Limit height and make scrollable if needed */
            overflow-y: auto; /* Add scroll if text too long */
        }

        .info-box p {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .info-box p strong {
             color: var(--dark);
        }

        .info-box p:last-child {
            margin-bottom: 0;
        }
         /* Style for Font Awesome icons */
        .info-box h3 .fas {
            margin-right: 8px;
            color: var(--secondary);
        }
         .modal-content h2 .fas {
            margin-right: 10px;
         }
         /* Style for result code in final stage info box */
        #final-stage .info-box code {
            background: #fff3cd; /* Light yellow background */
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
            color: #856404; /* Dark yellow text */
            font-size: 1.1em; /* Slightly larger */
        }


        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .stage-number {
            background-color: var(--primary);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.3rem;
            margin-right: 15px;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .stage-title {
            display: flex;
            align-items: center;
        }
         .stage-title h2 {
             margin-bottom: 0; /* Remove margin from h2 inside */
         }

        .stage-time {
            background-color: var(--gray);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            white-space: nowrap; /* Prevent wrapping */
        }

        .team-info {
            background-color: white;
            border-radius: 5px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eee;
        }

        .team-name {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .stage-indicator {
            display: flex;
            gap: 8px;
        }

        .stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ddd;
            transition: background-color 0.3s;
        }

        .stage-dot.active {
            background-color: var(--warning); /* Yellow for active */
        }

        .stage-dot.completed {
            background-color: var(--success); /* Green for completed */
        }

         /* Backdoor button style */
        #backdoor-btn {
            position: absolute;
            top: 5px; /* Adjust position */
            right: 5px; /* Adjust position */
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.2); /* Very subtle */
            cursor: pointer;
            font-size: 1.2rem; /* Smaller */
            padding: 5px;
            z-index: 10; /* Ensure it's clickable */
            transition: color 0.3s;
        }
        #backdoor-btn:hover {
            color: rgba(255, 255, 255, 0.6); /* Less subtle on hover */
        }

        /* Styles for Hiding/Showing Regulatory Info */
        .regulatory-info {
            display: block; /* Keep block for layout calculation */
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity 0.6s ease-out, max-height 0.6s ease-out, margin-top 0.6s ease-out, padding-top 0.6s ease-out, padding-bottom 0.6s ease-out, border-width 0.6s ease-out;
            margin-top: 0 !important; /* Collapse margin when hidden */
            padding-top: 0 !important; /* Collapse padding when hidden */
            padding-bottom: 0 !important;
            border-left-width: 0 !important; /* Hide border when collapsed */
            border-top-width: 0 !important;
            border-bottom-width: 0 !important;
            border-right-width: 0 !important;
             border-color: transparent !important; /* Hide color too */
        }

        .regulatory-info.visible {
            opacity: 1;
            max-height: 1000px; /* Large enough to fit content */
            margin-top: 25px !important; /* Restore original margin */
            padding-top: 20px !important; /* Restore original padding */
            padding-bottom: 20px !important;
            border-left-width: 5px !important; /* Restore border */
            border-top-width: 1px !important;
            border-bottom-width: 1px !important;
            border-right-width: 1px !important;
            border-style: solid !important; /* Ensure border style is applied */
             border-color: #eee #eee #eee var(--secondary) !important; /* Restore border colors */
            border-radius: 0 8px 8px 0 !important; /* Restore border-radius */
        }

        /* REMOVED Countdown timer related CSS */


        @media (max-width: 992px) {
             .item { width: calc(33.333% - 10px); }
             .card { width: calc(50% - 8px); } /* Applied to all card containers */
             #available-logistics-steps .card { width: calc(50% - 8px); } /* Explicitly for stage 3 */
        }


        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            .item { width: calc(50% - 8px); } /* 2 items per row */
            .card { width: calc(50% - 8px); }
            #available-logistics-steps .card { width: calc(50% - 8px); } /* Still 2 per row on tablets */
            .drop-zones { flex-direction: column; }
            .certificate { padding: 25px; }
            .certificate-seal { width: 70px; height: 70px; font-size: 0.9rem; bottom: 15px; right: 15px; }
            .stage-header { align-items: flex-start; }
             .stage-title h2 { font-size: 1.3rem; }
             /* .map-container { height: 300px; } */ /* Removed */
        }

        @media (max-width: 480px) {
             h1 { font-size: 1.3rem; }
            .item { width: 100%; } /* 1 item per row */
            .card { width: 100%; } /* 1 card per row */
            #available-logistics-steps .card { width: 100%; } /* 1 card per row */
            .dropped-item { width: 100%; } /* Ensure dropped items stack */
            .timer { font-size: 1.5rem; padding: 8px 15px; }
            .stage-header { flex-direction: column; align-items: flex-start; }
            .stage-time { margin-top: 10px; }
            .stage-title h2 { font-size: 1.2rem; }
            .team-info { flex-direction: column; align-items: flex-start; gap: 10px; }
            .modal-content { padding: 20px; }
             .close { top: 10px; right: 15px; font-size: 1.8rem; }
             .certificate { padding: 20px; }
             .certificate h2 { font-size: 1.5rem; }
              .certificate ul { padding-left: 5px; } /* Less indent on mobile */
             .certificate-seal { width: 60px; height: 60px; font-size: 0.8rem; }
             /* .map-container { height: 250px; } */ /* Removed */
             /* .map-point { width: 35px; height: 35px; font-size: 1.2rem; } */ /* Removed */
             .timer-container { gap: 5px; } /* Reduce gap for smaller screens */
        }

        /* Styles for Printing the Certificate - REMOVED/IGNORED FOR PDF */
        @media print {
            /* Styles here might interfere with html2canvas, better to rely on screen styles */
            /* Keeping @page for basic print layout if user manually prints */
             @page {
                size: A4;
                margin: 1.5cm; /* Standard margin */
            }
            /* Hide buttons when printing manually */
             #success > div:last-of-type { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ALERTE MNU : Mission conformité</h1>
            <p>Une mission critique pour sécuriser la filière des Médicaments Non Utilisés</p>
            <button id="backdoor-btn" title="Accès spécial">
                <i class="fas fa-door-open"></i>
            </button>
        </header>

        <div class="team-info">
            <div class="team-name" id="team-name-display">Équipe: Non définie</div>
            <div class="stage-indicator">
                <div class="stage-dot" data-stage="1"></div>
                <div class="stage-dot" data-stage="2"></div>
                <div class="stage-dot" data-stage="3"></div>
                <div class="stage-dot" data-stage="4"></div>
                <div class="stage-dot" data-stage="5"></div>
            </div>
        </div>

        <div class="timer-container">
            <div class="timer" id="timer">10:00</div>
            <!-- Previous Stage Button Added Here -->
            <button class="btn btn-secondary" id="prev-stage-btn" style="display: none;">Étape Précédente</button>
            <!-- Help Button - visibility controlled by JS -->
            <button class="btn btn-help" id="show-help" style="display: none;">Aide</button>
        </div>

        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>

        <!-- Introduction -->
        <div class="stage intro active" id="intro">
            <h2 id="intro-title">Message urgent des ministères de la Santé et de l'Environnement</h2>
            <p><strong>🔊 Bip... Bip... Alerte Interministérielle !</strong></p>
            <p>Une <strong>faille critique</strong> menace la chaîne de gestion des Médicaments Non Utilisés (MNU). Risques sanitaires et environnementaux majeurs détectés !</p>
            <p>Vous êtes une <strong>cellule d'experts interministérielle</strong> dépêchée en urgence. Votre mission : auditer la filière en <strong>10 minutes chrono</strong>, identifier les non-conformités réglementaires (CSP, C. Env.) et <strong>restaurer l'intégrité du système</strong>.</p>
            <p>Le temps presse !</p>

            <div class="input-group" id="team-name-group">
                <label for="team-name">Nom de votre équipe d'experts :</label>
                <input type="text" id="team-name" placeholder="Entrez le nom de votre équipe">
            </div>
            <div class="input-group" id="participants-group">
                <label for="participant-names">Noms des participants (un par ligne) :</label>
                <textarea id="participant-names" rows="3" placeholder="Jean Dupont&#10;Marie Durand&#10;..."></textarea>
            </div>

            <button class="btn btn-primary" id="start-game">Commencer la mission (10 min)</button>
        </div>

        <!-- Stage 1: Le Tri Impossible à l'Officine -->
        <div class="stage" id="stage1">
            <div class="stage-header">
                <div class="stage-title">
                    <div class="stage-number">1</div>
                    <h2>Le Tri Impossible à l'Officine</h2>
                </div>
                <div class="stage-time">~3 minutes</div>
            </div>

            <p>Première étape : l'officine. Des patients ont rapporté divers objets. Conformément à la réglementation, déterminez précisément quels objets relèvent de la collecte spécifique des MNU par l'éco-organisme et lesquels sont exclus.</p>
            <p><strong>Cliquez sur les objets pour les sélectionner, puis cliquez sur la zone de destination (✅ MNU ou ❌ Exclus).</strong> Cliquez sur un objet dans une zone pour le retirer.</p>

            <h3>Objets rapportés par les particuliers :</h3>
            <div class="item-container" id="items-to-sort">
                 <div class="item" data-item="medicament-plein">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='10' y='10' width='80' height='40' rx='5' fill='%23fff' stroke='%23333' stroke-width='2'/><rect x='20' y='20' width='60' height='20' rx='2' fill='%23f8f9fa'/><text x='50' y='35' font-family='Arial' font-size='10' text-anchor='middle'>Médicament</text></svg>" alt="Boîte de médicaments">
                    <p>Boîte de médicaments (humain) non entamée</p>
                </div>
                <div class="item" data-item="medicament-entame">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='10' y='10' width='80' height='40' rx='5' fill='%23fff' stroke='%23333' stroke-width='2'/><rect x='20' y='20' width='60' height='20' rx='2' fill='%23f8f9fa'/><text x='50' y='35' font-family='Arial' font-size='10' text-anchor='middle'>Médicament</text><line x1='70' y1='10' x2='90' y2='30' stroke='%23e63946' stroke-width='2'/></svg>" alt="Boîte de médicaments entamée">
                    <p>Boîte de médicaments (humain) entamée</p>
                </div>
                <div class="item" data-item="seringue">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><line x1='20' y1='40' x2='80' y2='20' stroke='%23333' stroke-width='2'/><rect x='20' y='35' width='15' height='10' fill='%23fff' stroke='%23333' stroke-width='2'/><rect x='35' y='32' width='30' height='5' fill='%23f8f9fa' stroke='%23333' stroke-width='1'/><circle cx='75' cy='22' r='5' fill='none' stroke='%23333' stroke-width='1'/></svg>" alt="Seringue usagée">
                    <p>Seringue usagée (DASTRI)</p>
                </div>
                <div class="item" data-item="thermometre">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='45' y='10' width='10' height='40' rx='5' fill='%23fff' stroke='%23333' stroke-width='2'/><circle cx='50' cy='45' r='5' fill='%23e63946'/><line x1='50' y1='15' x2='50' y2='40' stroke='%23333' stroke-width='1'/><line x1='45' y1='20' x2='55' y2='20' stroke='%23333' stroke-width='1'/><line x1='45' y1='30' x2='55' y2='30' stroke='%23333' stroke-width='1'/></svg>" alt="Thermomètre au mercure">
                    <p>Thermomètre au mercure</p>
                </div>
                <div class="item" data-item="complement">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='20' y='10' width='60' height='40' rx='5' fill='%23fff' stroke='%23333' stroke-width='2'/><text x='50' y='35' font-family='Arial' font-size='8' text-anchor='middle'>Complément</text><text x='50' y='45' font-family='Arial' font-size='8' text-anchor='middle'>Alimentaire</text></svg>" alt="Complément alimentaire">
                    <p>Complément alimentaire</p>
                </div>
                <div class="item" data-item="emballage">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><path d='M20,10 L80,10 L80,50 L20,50 Z' fill='none' stroke='%23333' stroke-width='2' stroke-dasharray='5,5'/><text x='50' y='35' font-family='Arial' font-size='8' text-anchor='middle'>Emballage</text><text x='50' y='45' font-family='Arial' font-size='8' text-anchor='middle'>vide</text></svg>" alt="Emballage carton vide">
                    <p>Emballage carton vide de médicament</p>
                </div>
                <div class="item" data-item="notice">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='20' y='10' width='60' height='40' fill='%23fff' stroke='%23333' stroke-width='1'/><line x1='30' y1='20' x2='70' y2='20' stroke='%23333' stroke-width='1'/><line x1='30' y1='30' x2='70' y2='30' stroke='%23333' stroke-width='1'/><line x1='30' y1='40' x2='50' y2='40' stroke='%23333' stroke-width='1'/></svg>" alt="Notice de médicament">
                    <p>Notice de médicament (papier)</p>
                </div>
                <div class="item" data-item="veterinaire">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='20' y='10' width='60' height='40' rx='5' fill='%23fff' stroke='%23333' stroke-width='2'/><text x='50' y='30' font-family='Arial' font-size='8' text-anchor='middle'>Médicament</text><text x='50' y='40' font-family='Arial' font-size='8' text-anchor='middle'>Vétérinaire</text><path d='M40,20 L45,15 L50,20 L55,15 L60,20' fill='none' stroke='%23333' stroke-width='1'/></svg>" alt="Médicament vétérinaire">
                    <p>Médicament vétérinaire</p>
                </div>
            </div>

            <div class="drop-zones">
                <div class="drop-zone" id="cyclamed-zone">
                    <h3>✅ Collecte MNU (Éco-organisme)</h3>
                    <div class="dropped-items"></div>
                </div>
                <div class="drop-zone" id="excluded-zone">
                    <h3>❌ Exclus MNU</h3>
                    <div class="dropped-items"></div>
                </div>
            </div>

            <button class="btn btn-primary" id="validate-stage1">Valider le tri</button>
            <div class="feedback" id="stage1-feedback"></div>
            <div class="info-box regulatory-info">
                <h3><i class="fas fa-book"></i> Textes applicables</h3>
                <p><strong>Article L. 5111-1 du Code de la santé publique :</strong></p>
                <p class="leg-text">"On entend par médicament à usage humain toute substance ou composition présentée comme possédant des propriétés curatives ou préventives à l'égard des maladies humaines, ainsi que toute substance ou composition pouvant être utilisée chez l'homme ou pouvant lui être administrée, en vue d'établir un diagnostic médical ou de restaurer, corriger ou modifier ses fonctions physiologiques en exerçant une action pharmacologique, immunologique ou métabolique."</p>
                <p><strong>Article R. 4211-23 du Code de la santé publique:</strong></p>
                <p class="leg-text">"IV.-Pour l'application de la présente section, on entend par : [...] 2° “ Médicaments non utilisés ”, les médicaments à usage humain inutilisés ou périmés détenus par les particuliers."</p>
                <p><strong>Produits non concernés :</strong></p>
                 <p class="leg-text">Sont exclus du champ des MNU (liste non exhaustive) :
- Les conditionnements primaires vides et secondaires (relevant de la REP emballages ménagers).
- Les dispositifs médicaux perforants des patients en auto-traitement (relevant de la filière DASTRI - Art. R. 1335-8-1 et suivants CSP).
- Les médicaments vétérinaires.
- Les produits de parapharmacie, cosmétiques, compléments alimentaires, etc. (non définis comme médicaments à usage humain).
- Les thermomètres, produits chimiques, etc.</p>
            </div>
            <div class="next-stage-container" id="next-stage-container-1" style="display: none; margin-top: 15px;">
                <button class="btn btn-success next-stage-btn" id="next-stage-1" disabled>
                     Passer à l'étape suivante
                </button>
            </div>
        </div>

        <!-- Stage 2: Le Producteur Amnésique -->
        <div class="stage" id="stage2">
            <div class="stage-header">
                <div class="stage-title">
                    <div class="stage-number">2</div>
                    <h2>Le Producteur Amnésique</h2>
                </div>
                <div class="stage-time">~2 minutes</div>
            </div>
            <p>Identifiez le "producteur" REP MNU et ses obligations fondamentales selon les textes.</p>
            <p><strong>Cliquez sur les bonnes réponses.</strong></p>
            <h3>Qui est le "producteur" REP pour les MNU?</h3>
            <div class="card-container" id="producer-cards">
                 <div class="card" data-card="fabricant">Le fabricant physique du médicament</div>
                <div class="card" data-card="exploitant">L'exploitant pharmaceutique</div>
                <div class="card" data-card="pharmacien">L'ensemble des pharmaciens d'officine</div>
                <div class="card" data-card="grossiste">Les grossistes-répartiteurs</div>
            </div>
            <h3>Quelles sont les obligations FONDAMENTALES du producteur?</h3>
            <div class="card-container" id="obligation-cards">
                 <div class="card" data-card="financer">Financer la filière (contribuer à gestion déchets)</div>
                <div class="card" data-card="adherer">Adhérer à un éco-organisme (ou système individuel)</div>
                <div class="card" data-card="collecter-physiquement">Organiser la collecte physique lui-même</div>
                <div class="card" data-card="eco-concevoir">Adopter une démarche d'éco-conception</div>
                <div class="card" data-card="pharmacovigilance">Assurer la pharmacovigilance</div>
                <div class="card" data-card="detruire">Détruire lui-même les MNU</div>
            </div>
            <button class="btn btn-primary" id="validate-stage2">Valider les responsabilités</button>
            <div class="feedback" id="stage2-feedback"></div>
            <div class="info-box regulatory-info">
                 <h3><i class="fas fa-book"></i> Textes applicables</h3>
                 <p><strong>Article R. 4211-23 IV 1° du Code de la santé publique :</strong></p>
                 <p class="leg-text">"1° “ Producteur ” au sens du I de l'article L. 541-10 du code de l'environnement, les exploitants mentionnés au 3° de l'article R. 5124-2 du code de la santé publique ;"</p>
                  <p><strong>Article R. 5124-2 3° du Code de la santé publique (Extrait) :</strong></p>
                 <p class="leg-text">"3° Exploitant, l'entreprise ou l'organisme se livrant à l'exploitation de médicaments [...]"</p>
                 <p><strong>Article L. 541-10 I du Code de l'environnement :</strong></p>
                 <p class="leg-text">"[...] il peut être fait obligation à toute personne physique ou morale qui élabore, fabrique, manipule, traite, vend ou importe des produits générateurs de déchets [...] de pourvoir ou de contribuer à la prévention et à la gestion des déchets qui en proviennent ainsi que d'adopter une démarche d'écoconception des produits [...] Pour s'acquitter de cette obligation, les producteurs mettent en place collectivement des éco-organismes [...] auxquels ils transfèrent leur obligation et versent en contrepartie une contribution financière. [...]"</p>
            </div>
            <div class="next-stage-container" id="next-stage-container-2" style="display: none; margin-top: 15px;">
                <button class="btn btn-success next-stage-btn" id="next-stage-2" disabled>
                    Passer à l'étape suivante
                </button>
            </div>
        </div>

        <!-- Stage 3: La Logistique Séquentielle -->
        <div class="stage" id="stage3">
             <div class="stage-header">
                <div class="stage-title">
                    <div class="stage-number">3</div>
                    <!-- Titre modifié -->
                    <h2>La Logistique Séquentielle</h2>
                </div>
                <div class="stage-time">~2 minutes</div>
            </div>
            <!-- Instructions modifiées -->
            <p>Reconstituez le parcours chronologique des MNU depuis leur collecte jusqu'à leur élimination finale.</p>
            <p><strong>Cliquez sur les étapes/actions ci-dessous DANS L'ORDRE CORRECT pour les ajouter à la séquence.</strong> Cliquez sur une étape dans votre séquence pour la retirer.</p>

            <!-- Suppression du map-container -->

            <h3>Étapes / Actions Disponibles :</h3>
            <!-- Container des étapes disponibles, maintenant avec un ID différent pour éviter confusion -->
            <div class="card-container" id="available-logistics-steps">
                 <!-- Les cartes restent similaires, mais leur comportement changera via JS -->
                 <!-- Assurez-vous que data-step-id est unique et correspond à la logique -->
                 <div class="card" data-step-id="pharmacie">Collecte gratuite à l'officine</div>
                 <div class="card" data-step-id="receptacle">Stockage dans réceptacle sécurisé</div>
                 <div class="card" data-step-id="enlevement">Enlèvement depuis l'officine par prestataire</div>
                 <div class="card" data-step-id="regroupement">Regroupement / Tri sur plateforme logistique</div>
                 <div class="card" data-step-id="transport">Transport vers l'unité de traitement</div>
                 <!-- L'incinération est maintenant une étape comme les autres -->
                 <div class="card" data-step-id="incineration">Destruction finale par incinération</div>
                 <!-- On peut ajouter quelques leurres si désiré -->
                 <div class="card" data-step-id="recyclage">Recyclage chimique</div>
                 <div class="card" data-step-id="humanitaire">Redistribution humanitaire</div>
            </div>

            <!-- Nouvelle section pour afficher la séquence construite par l'utilisateur -->
            <div class="ordered-sequence-area">
                <h3>Votre Séquence Construite :</h3>
                <ol id="built-sequence-list"></ol>
                <!-- Ajout d'un bouton pour vider la séquence si besoin -->
                <button class="btn btn-help btn-sm" id="clear-sequence-btn">Recommencer la séquence</button>
            </div>

            <!-- Suppression de la section "Destination finale imposée?" -->

            <!-- Bouton de validation et feedback restent -->
            <button class="btn btn-primary" id="validate-stage3" style="margin-top: 20px;" disabled>Valider la Séquence</button>
            <div class="feedback" id="stage3-feedback"></div>

            <!-- L'info réglementaire peut rester -->
            <div class="info-box regulatory-info">
                 <h3><i class="fas fa-book"></i> Textes applicables</h3>
                 <p><strong>Article R. 4211-24 du Code de la santé publique :</strong></p>
                 <p class="leg-text">"Les producteurs [...] réalisent les opérations suivantes :
1° La remise, à titre gratuit, de réceptacles aux officines de pharmacie ;
2° L'enlèvement, le regroupement, le tri et le transport des médicaments non utilisés [...] depuis les officines de pharmacie jusqu'à leur lieu de destination ;
3° La destruction des médicaments non utilisés."</p>
                 <p><strong>Article R. 4211-27 du Code de la santé publique :</strong></p>
                 <p class="leg-text">"Les médicaments non utilisés sont détruits par incinération avec valorisation énergétique dans le respect de la réglementation en vigueur."</p>
                 <p><strong>Note :</strong> Redistribution/réutilisation interdite.</p>
            </div>
            <div class="next-stage-container" id="next-stage-container-3" style="display: none; margin-top: 15px;">
                <button class="btn btn-success next-stage-btn" id="next-stage-3" disabled>
                    Passer à l'étape suivante
                </button>
            </div>
        </div>

         <!-- Stage 4: Le Cahier des Charges Oublié -->
        <div class="stage" id="stage4">
             <div class="stage-header">
                <div class="stage-title">
                    <div class="stage-number">4</div>
                    <h2>Le Cahier des charges oublié</h2>
                </div>
                <div class="stage-time">~1 minute</div>
            </div>
            <p>Retrouvez les infos clés sur l'éco-organisme MNU : objectif, statut, nom.</p>
            <p><strong>Sélectionnez les bonnes réponses et tapez le nom.</strong></p>
            <h3>Objectif MINIMAL de collecte (%) fixé ?</h3>
            <div class="card-container" id="collection-target">
                <div class="card" data-target="50">50%</div>
                <div class="card" data-target="60">60%</div>
                <div class="card" data-target="70">70%</div>
                <div class="card" data-target="80">80%</div>
            </div>
            <h3>Statut juridique obligatoire (L.541-10 C. Env) ?</h3>
            <div class="card-container" id="eco-org-nature">
                <div class="card" data-nature="lucratif">Société commerciale</div>
                <div class="card" data-nature="non-lucratif">Organisme à but non lucratif</div>
                <div class="card" data-nature="publique">Service public</div>
                <div class="card" data-nature="association">Association 1901</div>
            </div>
            <h3>Nom de l'éco-organisme agréé MNU ?</h3>
            <div class="input-group">
                <input type="text" id="eco-org-name" placeholder="Entrez le nom">
            </div>
            <button class="btn btn-primary" id="validate-stage4">Valider les informations clés</button>
            <div class="feedback" id="stage4-feedback"></div>
            <div class="info-box regulatory-info">
                 <h3><i class="fas fa-book"></i> Textes Réglementaires & Arrêtés Applicables</h3>
                 <p><strong>Extrait Cahier des Charges (Arrêté 29 oct. 2021) :</strong></p>
                 <p class="leg-text">"2.1. Objectifs de collecte [...] Objectif du pourcentage minimal des MNU collectés : 70%"</p>
                 <p><strong>Article L. 541-10 I C. Env (Extrait Statut) :</strong></p>
                 <p class="leg-text">"[...] les éco-organismes [...] sont à but non lucratif."</p>
                 <p><strong>Extrait Arrêté d'agrément (22 déc. 2021) :</strong></p>
                 <p class="leg-text">"Est agréé, [...] l'organisme Cyclamed [...] en tant qu'éco-organisme [...]"</p>
            </div>
            <div class="next-stage-container" id="next-stage-container-4" style="display: none; margin-top: 15px;">
                <button class="btn btn-success next-stage-btn" id="next-stage-4" disabled>
                    Passer à l'étape suivante
                </button>
            </div>
        </div>


        <!-- Final Stage: Validation du Système -->
        <div class="stage" id="final-stage">
             <div class="stage-header">
                <div class="stage-title">
                    <div class="stage-number">5</div>
                    <h2>Restauration du Système</h2>
                </div>
                <div class="stage-time">~1 minute</div>
            </div>
            <p>Mission presque accomplie ! Entrez le code numérique et le mot de passe final pour verrouiller la conformité de la filière MNU.</p>
            <div class="info-box">
                <h3><i class="fas fa-key"></i> Calcul du Code d'Accès Final</h3>
                 <!-- MODIFIED Text below -->
                 <p id="final-code-desc"><strong>Code Numérique :</strong> (Nb items ✅ E1 = <strong id="final-val-e1">?</strong>) + (Objectif % E4 = <strong id="final-val-e4-target">?</strong>) + (N° Article REP C. Env = <strong id="final-val-e3">?</strong>)</p>
                 <!-- MODIFIED Calculation display text -->
                 <p id="final-code-calc" style="text-align: center; font-weight: bold; font-size: 1.1rem;">Code = [<span id="final-calc-e1">?</span>][<span id="final-calc-e4-target">?</span>][<span id="final-calc-e3">?</span>] = <code id="final-code-result">?????</code></p>
                 <p id="final-password-desc"><strong>Mot de Passe :</strong> (Lettre obligation E2 = <strong id="final-val-e2">?</strong>) + (Nom éco-org E4 = <strong id="final-val-e4-name">?</strong>)</p>
                 <p id="final-password-calc" style="text-align: center; font-weight: bold; font-size: 1.1rem;">Mot de Passe = [<span id="final-calc-e2">?</span>][<span id="final-calc-e4-name">?</span>] = <code id="final-password-result">?????????</code></p>
                 <p>(Utilisez l'aide <i class="fas fa-life-ring"></i> pour les indices si besoin)</p>
            </div>
            <div class="input-group">
                <label for="final-code">Code numérique de restauration :</label>
                <input type="text" id="final-code" placeholder="Code à 5 chiffres">
            </div>
            <div class="input-group">
                <label for="final-password">Mot de passe de conformité :</label>
                <input type="text" id="final-password" placeholder="Mot de passe alphanumérique">
            </div>
            <div class="feedback" id="final-feedback"></div>
            <button class="btn btn-primary" id="validate-final">Valider et sécuriser la filière</button>
        </div>

        <!-- Success Screen -->
        <div class="stage" id="success">
            <div class="certificate" id="certificate-content">
                <h2><i class="fas fa-shield-alt"></i> CERTIFICAT DE CONFORMITÉ MNU</h2>
                <p>Félicitations à l'équipe <strong id="team-name-display-cert" style="color: var(--primary);"></strong> !</p>
                <div id="participants-section-cert" style="margin-top: 15px; text-align: left;">
                    <h4>Participants :</h4>
                    <ul id="participant-list-cert" style="list-style: none; padding-left: 10px; font-size: 0.9rem;"></ul>
                </div>
                <p style="margin-top: 20px;"><strong>Mission accomplie en <span id="time-taken"></span> !</strong> La filière MNU est sécurisée !</p>
                <p>Temps restant : <strong id="time-remaining" style="color: var(--success);"></strong></p>
                <h3 style="margin-top: 25px;">Synthèse Réglementaire :</h3>
                 <ul>
                    <li><strong>Périmètre MNU :</strong> Médicaments usage humain particuliers (L.5111-1, R.4211-23 CSP).</li>
                    <li><strong>Responsabilité :</strong> Producteur = Exploitant (R.4211-23, R.5124-2 CSP ; L.541-10 C. Env).</li>
                    <li><strong>Collecte :</strong> Gratuite en pharmacie (R.4211-24 CSP).</li>
                    <li><strong>Traitement :</strong> Incinération obligatoire (R.4211-27 CSP).</li>
                    <li><strong>Objectif :</strong> Collecte min. 70% (Cahier Charges 2021).</li>
                    <li><strong>Acteur :</strong> CYCLAMED (éco-org agréé non lucratif).</li>
                </ul>
                <div class="certificate-seal">CONFORME</div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" id="download-pdf-certificate">
                    <i class="fas fa-file-pdf"></i> Télécharger le Certificat (PDF)
                </button>
                <button class="btn btn-success" id="restart-game">Nouvelle mission d'audit</button>
            </div>
        </div>


        <!-- Failure Screen -->
        <div class="stage" id="failure">
            <div style="text-align:center;">
                 <h2 style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> Mission échouée</h2>
                 <p style="font-size: 3rem; margin: 15px 0;">⏳</p>
                 <p><strong>Temps écoulé !</strong> La non-conformité persiste.</p>
                 <p>Revoyez les textes réglementaires et réessayez !</p>
                 <button class="btn btn-danger" id="restart-game-failure" style="margin-top: 20px;">Relancer la Mission</button>
            </div>
        </div>

        <!-- Help Modal -->
        <div class="modal" id="help-modal">
            <div class="modal-content">
                <span class="close" id="close-help">×</span>
                <h2><i class="fas fa-life-ring"></i> Aide de Mission - Indices Clés</h2>
                <h3>Étape 1 : Tri</h3>
                <p>Seuls les médicaments à usage humain des particuliers sont des MNU (<code>R.4211-23 CSP</code>). Attention aux exclusions (DASTRI, emballages vides...).</p>
                <p>Indice code final : Le <strong>nombre</strong> d'items corrects dans la zone ✅ MNU.</p>
                <h3>Étape 2 : Producteur</h3>
                <p>Qui est "l'exploitant" ? (<code>R.4211-23</code>, <code>R.5124-2 CSP</code>). Quelles sont ses obligations REP principales ? (<code>L.541-10 C. Env</code>).</p>
                <p>Indice mot de passe : La <strong>première lettre</strong> de l'obligation de contribution financière.</p>
                <h3>Étape 3 : Logistique Séquentielle</h3>
                 <!-- MODIFIED Hint Below -->
                 <p>Réfléchissez à l'ordre logique des actions depuis le dépôt en pharmacie jusqu'à l'élimination. Consultez <code>R.4211-24 CSP</code> pour les étapes clés et <code>L.541-10 C. Env</code> pour la notion fondamentale de REP.</p>
                 <p>Indice code final : Le numéro (<code>??</code>) de l'article fondateur de la REP dans le Code de l'Environnement (<code>L.541-??</code>) est nécessaire.</p>
                <h3>Étape 4 : Éco-organisme</h3>
                <p>Trouvez l'objectif chiffré (Cahier des charges), le statut légal (<code>L.541-10 C. Env</code>) et le nom (Arrêté d'agrément).</p>
                <p>Indices code/mdp : Le <strong>pourcentage</strong> de l'objectif et le <strong>nom exact</strong>.</p>
                <hr style="margin: 20px 0;">
                <h3>Étape Finale : Calcul des Codes</h3>
                <!-- MODIFIED Formula Description -->
                <p><strong>Code Numérique :</strong> (Nb items ✅ E1) + (Objectif % E4) + (N° Article REP C.Env)</p>
                 <p><i>Format attendu: XYYZZ (où ZZ vient de L.541-??)</i></p>
                <p><strong>Mot de Passe :</strong> (Lettre obligation E2) + (Nom éco-org E4)</p>
                 <p><i>Format attendu: LNOM</i></p>
            </div>
        </div>

    </div> <!-- End Container -->

    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" integrity="sha512-Tn2m0TIpgVyTzzvmxLNuqbSJH3JP8jm+Cy3hvHrW7ndTDcJ1w5mBiksqDBb8GpE2ksktFvDB/ykZ0mDpsZj20w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- jsPDF and html2canvas Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    <script>
        // --- Game State ---
        const gameState = {
            teamName: '',
            participants: [],
            startTime: null,
            totalGameTime: 10 * 60 * 1000,
            timeRemaining: 10 * 60 * 1000,
            timerInterval: null,
            currentStage: 'intro',
            // Added failures count and stage timer tracking
            stageResults: {
                stage1: { completed: false, correctItemsCount: 0, failures: 0 },
                stage2: { completed: false, producerCorrect: false, obligationsCorrect: false, keyLetter: '', failures: 0 },
                stage3: { completed: false, builtSequence: [], sequenceCorrect: false, failures: 0 },
                stage4: { completed: false, collectionTarget: '', ecoOrgNatureCorrect: false, ecoOrgNameCorrect: false, ecoOrgName: '', failures: 0 }
            },
            finalCode: '',
            finalPassword: '',
            currentStageStartTime: null, // Track when the current stage started
            helpCheckInterval: null // Interval for checking help conditions
        };

        // --- Constants ---
        const HELP_FAILURE_THRESHOLD = 2; // Number of failures to show help
        const HELP_TIME_THRESHOLD = 2 * 60 * 1000; // 2 minutes in milliseconds
        const stageOrder = ['intro', 'stage1', 'stage2', 'stage3', 'stage4', 'final-stage', 'success', 'failure']; // Order for navigation

        // Define the correct sequence for Stage 3
        const correctLogisticsSequence = [
            'pharmacie',
            'receptacle',
            'enlevement',
            'regroupement',
            'transport',
            'incineration' // Note: Matches data-step-id of the final correct step card
        ];

        // --- DOM Elements ---
        const timerElement = document.getElementById('timer');
        const progressElement = document.getElementById('progress');
        const teamNameInput = document.getElementById('team-name');
        const participantNamesInput = document.getElementById('participant-names');
        const teamNameDisplay = document.getElementById('team-name-display');
        const teamNameDisplayCert = document.getElementById('team-name-display-cert');
        const participantListCert = document.getElementById('participant-list-cert');
        const startGameButton = document.getElementById('start-game');
        const stages = document.querySelectorAll('.stage');
        const stageDots = document.querySelectorAll('.stage-dot');
        const itemsContainer = document.getElementById('items-to-sort');
        const cyclamedZone = document.getElementById('cyclamed-zone').querySelector('.dropped-items');
        const excludedZone = document.getElementById('excluded-zone').querySelector('.dropped-items');
        const validateStage1Button = document.getElementById('validate-stage1');
        const validateStage2Button = document.getElementById('validate-stage2');
        const validateStage3Button = document.getElementById('validate-stage3'); // Kept
        const validateStage4Button = document.getElementById('validate-stage4');
        const validateFinalButton = document.getElementById('validate-final');
        const nextStageContainer1 = document.getElementById('next-stage-container-1');
        const nextStageBtn1 = document.getElementById('next-stage-1');
        const nextStageContainer2 = document.getElementById('next-stage-container-2');
        const nextStageBtn2 = document.getElementById('next-stage-2');
        const nextStageContainer3 = document.getElementById('next-stage-container-3'); // Kept
        const nextStageBtn3 = document.getElementById('next-stage-3'); // Kept
        const nextStageContainer4 = document.getElementById('next-stage-container-4');
        const nextStageBtn4 = document.getElementById('next-stage-4');
        const stage1Feedback = document.getElementById('stage1-feedback');
        const stage2Feedback = document.getElementById('stage2-feedback');
        const stage3Feedback = document.getElementById('stage3-feedback'); // Kept
        const stage4Feedback = document.getElementById('stage4-feedback');
        const finalFeedback = document.getElementById('final-feedback');
        const producerCardsContainer = document.getElementById('producer-cards');
        const obligationCardsContainer = document.getElementById('obligation-cards');
        // REMOVED: logisticsStepsContainer, finalDestinationContainer, logisticsMap
        const availableLogisticsStepsContainer = document.getElementById('available-logistics-steps'); // NEW
        const builtSequenceList = document.getElementById('built-sequence-list'); // NEW
        const clearSequenceButton = document.getElementById('clear-sequence-btn'); // NEW
        const collectionTargetContainer = document.getElementById('collection-target');
        const ecoOrgNatureContainer = document.getElementById('eco-org-nature');
        const ecoOrgNameInput = document.getElementById('eco-org-name');
        const finalCodeInput = document.getElementById('final-code');
        const finalPasswordInput = document.getElementById('final-password');
        const timeRemainingDisplay = document.getElementById('time-remaining');
        const timeTakenDisplay = document.getElementById('time-taken');
        const restartGameButton = document.getElementById('restart-game');
        const restartGameFailureButton = document.getElementById('restart-game-failure');
        const helpModal = document.getElementById('help-modal');
        const showHelpButton = document.getElementById('show-help'); // Existing button, visibility controlled
        const closeHelpButton = document.getElementById('close-help');
        const backdoorButton = document.getElementById('backdoor-btn');
        const downloadPdfButton = document.getElementById('download-pdf-certificate');
        const prevStageButton = document.getElementById('prev-stage-btn'); // New button
        const introTitleElement = document.getElementById('intro-title');
        const teamNameGroup = document.getElementById('team-name-group');
        const participantsGroup = document.getElementById('participants-group');
        const certificateContentElement = document.getElementById('certificate-content');


        // --- Core Game Logic ---

        function initGame() {
            // Event listeners
            startGameButton.addEventListener('click', startGame);
            validateStage1Button.addEventListener('click', validateStage1);
            validateStage2Button.addEventListener('click', validateStage2);
            validateStage3Button.addEventListener('click', validateStage3); // Stage 3 Validation
            validateStage4Button.addEventListener('click', validateStage4);
            validateFinalButton.addEventListener('click', validateFinal);
            nextStageBtn1.addEventListener('click', () => showStage('stage2'));
            nextStageBtn2.addEventListener('click', () => showStage('stage3'));
            nextStageBtn3.addEventListener('click', () => showStage('stage4')); // Stage 3 Next Button
            nextStageBtn4.addEventListener('click', () => showStage('final-stage'));
            restartGameButton.addEventListener('click', resetGame);
            restartGameFailureButton.addEventListener('click', resetGame);
            showHelpButton.addEventListener('click', () => helpModal.classList.add('active'));
            closeHelpButton.addEventListener('click', () => helpModal.classList.remove('active'));
            helpModal.addEventListener('click', (e) => { if (e.target === helpModal) helpModal.classList.remove('active'); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') helpModal.classList.remove('active'); });
            backdoorButton.addEventListener('click', handleBackdoor);
            downloadPdfButton.addEventListener('click', handleDownloadCertificatePDF);
            clearSequenceButton.addEventListener('click', clearBuiltSequence); // Listener for new Stage 3 clear button
            prevStageButton.addEventListener('click', goToPreviousStage); // Listener for Previous Stage button

            initStage1Interactions();
            initCardSelection(); // Handles Stages 2 & 4 card selection
            initStage3CardClicks(); // NEW: Handles Stage 3 specific card clicks
            shuffleAvailableLogisticsSteps(); // NEW: Shuffle Stage 3 cards

            resetGame();
        }

        function startGame() {
            if (!teamNameInput.value.trim()) {
                alert('Veuillez entrer un nom d\'équipe.');
                teamNameInput.focus();
                return;
            }
            if (introTitleElement) introTitleElement.style.display = 'none';
            gameState.teamName = teamNameInput.value.trim();
            teamNameDisplay.textContent = `Équipe: ${gameState.teamName}`;
            const namesString = participantNamesInput.value.trim();
            gameState.participants = namesString ? namesString.split('\n').map(name => name.trim()).filter(name => name !== '') : [];
            console.log("Participants:", gameState.participants);
            if (teamNameGroup) teamNameGroup.style.display = 'none';
            if (participantsGroup) participantsGroup.style.display = 'none';
            if (startGameButton) startGameButton.style.display = 'none';
            gameState.startTime = Date.now();
            gameState.timeRemaining = gameState.totalGameTime;
            startTimer();
            showStage('stage1');
        }

        function startTimer() {
            clearInterval(gameState.timerInterval);
            updateTimerDisplay();
            gameState.timerInterval = setInterval(() => {
                const elapsed = Date.now() - gameState.startTime;
                gameState.timeRemaining = Math.max(gameState.totalGameTime - elapsed, 0);
                if (gameState.timeRemaining <= 0) {
                    clearInterval(gameState.timerInterval); showStage('failure');
                }
                updateTimerDisplay();
            }, 1000);
        }

        function updateTimerDisplay() {
            const totalSeconds = Math.floor(gameState.timeRemaining / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerElement.classList.remove('warning', 'danger');
            if (minutes < 1) timerElement.classList.add('danger');
            else if (minutes < 3) timerElement.classList.add('warning');
        }

        function resetTimerDisplay() {
            const minutes = Math.floor(gameState.totalGameTime / (60 * 1000));
            const seconds = Math.floor((gameState.totalGameTime % (60 * 1000)) / 1000);
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerElement.classList.remove('warning', 'danger');
        }

        function showStage(stageId) {
            // Stop help check for the outgoing stage
            clearInterval(gameState.helpCheckInterval);

            stages.forEach(stage => stage.classList.remove('active'));
            const nextStage = document.getElementById(stageId);
            if (nextStage) {
                nextStage.classList.add('active');
                gameState.currentStage = stageId;

                // Reset failures and start time for the new stage (if it's a main stage 1-4)
                if (gameState.stageResults[stageId]) {
                    gameState.stageResults[stageId].failures = 0; // Reset failures on entering
                    gameState.currentStageStartTime = Date.now();
                    console.log(`Entered stage ${stageId} at ${new Date(gameState.currentStageStartTime).toLocaleTimeString()}`);
                    // Start checking if help should be shown for this stage (only if not already completed)
                    if (!gameState.stageResults[stageId].completed) {
                         startHelpCheckInterval(stageId);
                    }
                } else {
                    gameState.currentStageStartTime = null; // Not a main stage
                }

                 // Initially hide help and previous buttons
                 showHelpButton.style.display = 'none';
                 prevStageButton.style.display = 'none';
                 prevStageButton.disabled = true;

                 // Manage Previous Stage Button visibility
                 const currentStageIndex = stageOrder.indexOf(stageId);
                 if (currentStageIndex > 1 && currentStageIndex <= stageOrder.indexOf('final-stage')) { // Enable from stage 2 onwards
                    // Check if there's actually a completed stage before it
                    let previousCompletedStageExists = false;
                    for (let i = currentStageIndex - 1; i >= 1; i--) { // Check stages 1 up to current-1
                        const prevStageId = stageOrder[i];
                        if (gameState.stageResults[prevStageId] && gameState.stageResults[prevStageId].completed) {
                            previousCompletedStageExists = true;
                            break;
                        }
                    }
                    if (previousCompletedStageExists) {
                        prevStageButton.style.display = 'inline-block';
                        prevStageButton.disabled = false;
                    }
                 }

                 updateProgress();
                 updateStageDots();
                 window.scrollTo(0, 0);
            } else {
                console.error("Stage not found:", stageId);
            }
        }


        // New function to handle "Previous Stage" button click
        function goToPreviousStage() {
            const currentStageIndex = stageOrder.indexOf(gameState.currentStage);
            if (currentStageIndex <= 1) return; // Cannot go back from intro or stage 1

            // Find the most recently completed stage before the current one
            for (let i = currentStageIndex - 1; i >= 1; i--) { // Check stages 1 up to current-1
                const prevStageId = stageOrder[i];
                 if (gameState.stageResults[prevStageId] && gameState.stageResults[prevStageId].completed) {
                    console.log(`Going back from ${gameState.currentStage} to ${prevStageId}`);
                    showStage(prevStageId);
                    return; // Exit after finding the first completed previous stage
                }
            }
             console.warn("Could not find a previously completed stage to go back to.");
        }


        // New function to check conditions for showing help button
        function startHelpCheckInterval(stageId) {
            clearInterval(gameState.helpCheckInterval); // Clear previous interval if any

            // Don't start check if stage is already completed or not a main stage
            if (!gameState.stageResults[stageId] || gameState.stageResults[stageId].completed) {
                return;
            }

            console.log(`Starting help check interval for stage ${stageId}`);
            gameState.helpCheckInterval = setInterval(() => {
                if (gameState.currentStage !== stageId || !gameState.stageResults[stageId] || gameState.stageResults[stageId].completed) {
                    clearInterval(gameState.helpCheckInterval); // Stop if stage changed or completed
                    return;
                }

                const failures = gameState.stageResults[stageId].failures;
                const timeElapsed = gameState.currentStageStartTime ? Date.now() - gameState.currentStageStartTime : 0;
                const timeConditionMet = timeElapsed >= HELP_TIME_THRESHOLD;
                const failureConditionMet = failures >= HELP_FAILURE_THRESHOLD;

                // console.log(`Help check for ${stageId}: Failures=${failures}, Time Elapsed=${Math.round(timeElapsed/1000)}s`);

                if (timeConditionMet || failureConditionMet) {
                    console.log(`Help conditions met for ${stageId} (Time: ${timeConditionMet}, Failures: ${failureConditionMet}). Showing help button.`);
                    showHelpButton.style.display = 'inline-block';
                    clearInterval(gameState.helpCheckInterval); // Stop checking once shown
                }
            }, 5000); // Check every 5 seconds
        }

        // Helper function to check and potentially show help immediately after a failure
        function checkHelpConditionsAfterFailure(stageId) {
             if (!gameState.stageResults[stageId] || gameState.stageResults[stageId].completed || showHelpButton.style.display === 'inline-block') {
                 return; // Don't check if stage completed or help already visible
             }
             const failures = gameState.stageResults[stageId].failures;
             const timeElapsed = gameState.currentStageStartTime ? Date.now() - gameState.currentStageStartTime : 0;

             if (failures >= HELP_FAILURE_THRESHOLD || timeElapsed >= HELP_TIME_THRESHOLD) {
                 console.log(`Help conditions met immediately after failure for ${stageId}. Showing help button.`);
                 showHelpButton.style.display = 'inline-block';
                 clearInterval(gameState.helpCheckInterval); // Stop interval checking
             }
         }


        function updateProgress() {
             // Adjusted stage order for progress calculation
             const progressStageOrder = ['intro', 'stage1', 'stage2', 'stage3', 'stage4', 'final-stage', 'success', 'failure'];
             let currentProgressIndex = progressStageOrder.indexOf(gameState.currentStage);
             // Calculate percentage based on index (approximate)
             const progressPercentage = (currentProgressIndex / (progressStageOrder.length - 3)) * 100; // -3 to exclude intro, success, failure as steps
             progressElement.style.width = `${Math.min(100, Math.max(0, progressPercentage))}%`;
        }

        function updateStageDots() {
            const mainStages = ['stage1', 'stage2', 'stage3', 'stage4', 'final-stage'];
            let stageIndex = mainStages.indexOf(gameState.currentStage);
            // If on intro, no dots active. If success/failure, all completed.
            if (gameState.currentStage === 'intro') stageIndex = -1;
            if (gameState.currentStage === 'success' || gameState.currentStage === 'failure') stageIndex = mainStages.length;

            stageDots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                const dotStageId = mainStages[index];
                if (index < stageIndex) {
                    dot.classList.add('completed');
                } else if (index === stageIndex) {
                    dot.classList.add('active');
                }
                // Ensure dots reflect completed state even if navigating back
                if(gameState.stageResults[dotStageId] && gameState.stageResults[dotStageId].completed) {
                    dot.classList.remove('active');
                    dot.classList.add('completed');
                }
            });
        }

        function handleBackdoor() {
            const code = prompt("Code d'accès spécial ?");
            if (code === "SKIP") {
                skipStage(gameState.currentStage);
            } else if (code !== null) {
                alert("Code incorrect.");
            }
        }

        function updateFinalStageInfoDisplay() {
            const e1Value = gameState.stageResults.stage1.correctItemsCount || '?';
            const e4TargetValue = gameState.stageResults.stage4.collectionTarget || '?';
            const e3ArticleValue = '10'; // MODIFIED: Changed to 10 (from L.541-10)
            const e2LetterValue = gameState.stageResults.stage2.keyLetter || '?';
            const e4NameValue = gameState.stageResults.stage4.ecoOrgName || '?';
            const finalCode = gameState.finalCode || '?????';
            const finalPassword = gameState.finalPassword || '?????????';

            const valE1 = document.getElementById('final-val-e1');
            const valE4Target = document.getElementById('final-val-e4-target');
            const valE3 = document.getElementById('final-val-e3'); // ID remains the same
            const valE2 = document.getElementById('final-val-e2');
            const valE4Name = document.getElementById('final-val-e4-name');
            if (valE1) valE1.textContent = e1Value;
            if (valE4Target) valE4Target.textContent = e4TargetValue;
            if (valE3) valE3.textContent = e3ArticleValue; // Display the new value '10'
            if (valE2) valE2.textContent = e2LetterValue;
            if (valE4Name) valE4Name.textContent = e4NameValue;

            const calcE1 = document.getElementById('final-calc-e1');
            const calcE4Target = document.getElementById('final-calc-e4-target');
            const calcE3 = document.getElementById('final-calc-e3'); // ID remains the same
            const calcE2 = document.getElementById('final-calc-e2');
            const calcE4Name = document.getElementById('final-calc-e4-name');
            if (calcE1) calcE1.textContent = e1Value;
            if (calcE4Target) calcE4Target.textContent = e4TargetValue;
            if (calcE3) calcE3.textContent = e3ArticleValue; // Display the new value '10'
            if (calcE2) calcE2.textContent = e2LetterValue;
            if (calcE4Name) calcE4Name.textContent = e4NameValue;

            const codeResult = document.getElementById('final-code-result');
            const passwordResult = document.getElementById('final-password-result');
            if (codeResult) codeResult.textContent = finalCode;
            if (passwordResult) passwordResult.textContent = finalPassword;

            console.log("Final stage info display updated.");
        }

        function skipStage(currentStageId) {
            console.clear();
            console.log(`--- PORTE DÉROBÉE ACTIVÉE (Saut de l'Étape ${currentStageId}) ---`);
            let nextStageId = '';
            let infoBoxToShow = null;

             if (currentStageId === 'intro') {
                 if (teamNameGroup) teamNameGroup.style.display = 'none';
                 if (participantsGroup) participantsGroup.style.display = 'none';
                 if (startGameButton) startGameButton.style.display = 'none';
                 if (introTitleElement) introTitleElement.style.display = 'none';
                 if (!gameState.teamName) {
                    gameState.teamName = "Équipe Spéciale";
                    teamNameDisplay.textContent = `Équipe: ${gameState.teamName}`;
                    console.log("  - (Using default team name)");
                 }
                 if (!gameState.startTime) {
                     gameState.startTime = Date.now();
                     startTimer();
                     console.log("  - (Starting timer)");
                 }
                 nextStageId = 'stage1';
             } else {
                 const stageIndex = stageOrder.indexOf(currentStageId);
                 if (stageIndex >= 1 && stageIndex <= 4) { // Mark current stage as completed if skipping from 1-4
                      if(gameState.stageResults[currentStageId]) {
                          gameState.stageResults[currentStageId].completed = true;
                           // Set correct answers for skipped stage to allow final calc
                           switch(currentStageId) {
                               case 'stage1': gameState.stageResults.stage1.correctItemsCount = 2; break;
                               case 'stage2':
                                   gameState.stageResults.stage2.producerCorrect = true;
                                   gameState.stageResults.stage2.obligationsCorrect = true;
                                   gameState.stageResults.stage2.keyLetter = 'F';
                                   break;
                               case 'stage3':
                                    gameState.stageResults.stage3.builtSequence = [...correctLogisticsSequence];
                                    gameState.stageResults.stage3.sequenceCorrect = true;
                                   break;
                               case 'stage4':
                                   gameState.stageResults.stage4.collectionTarget = '70';
                                   gameState.stageResults.stage4.ecoOrgNatureCorrect = true;
                                   gameState.stageResults.stage4.ecoOrgNameCorrect = true;
                                   gameState.stageResults.stage4.ecoOrgName = 'CYCLAMED';
                                   break;
                           }
                           console.log(`  - Stage ${currentStageId} marked as completed with correct answers set.`);
                           infoBoxToShow = document.querySelector(`#${currentStageId} .regulatory-info`);
                           if(infoBoxToShow) infoBoxToShow.classList.add('visible'); // Show info for skipped stage
                      }
                 }

                // Determine next stage
                switch (currentStageId) {
                    case 'stage1': nextStageId = 'stage2'; break;
                    case 'stage2': nextStageId = 'stage3'; break;
                    case 'stage3': nextStageId = 'stage4'; break;
                    case 'stage4':
                        // Ensure previous stage data exists before calculating final code
                        if (!gameState.stageResults.stage1.correctItemsCount) gameState.stageResults.stage1.correctItemsCount = 2;
                        if (!gameState.stageResults.stage2.keyLetter) gameState.stageResults.stage2.keyLetter = 'F';
                        if (!gameState.stageResults.stage4.ecoOrgName) gameState.stageResults.stage4.ecoOrgName = 'CYCLAMED';
                        if (!gameState.stageResults.stage4.collectionTarget) gameState.stageResults.stage4.collectionTarget = '70';

                        // MODIFIED: Calculate final code using 10 instead of 27
                        gameState.finalCode = `${gameState.stageResults.stage1.correctItemsCount}${gameState.stageResults.stage4.collectionTarget}10`;
                        gameState.finalPassword = `${gameState.stageResults.stage2.keyLetter}${gameState.stageResults.stage4.ecoOrgName}`;
                        console.log("------------------------------------");
                        console.log("Code Final Calculé (après skip):", gameState.finalCode);
                        console.log("Mot de Passe Final Calculé (après skip):", gameState.finalPassword);
                        console.log("------------------------------------");
                        updateFinalStageInfoDisplay();
                        nextStageId = 'final-stage';
                        break;
                    default:
                        console.log("Impossible de sauter depuis l'étape actuelle:", currentStageId);
                        alert("Impossible de sauter cette étape.");
                        return;
                }
             }

            console.log("-------------------------------------------------------------");
            if(nextStageId) showStage(nextStageId);
        }


        // --- Stage Specific Interactions & Validations ---

        // == Stage 1: Tri ==
        function initStage1Interactions() {
            itemsContainer.querySelectorAll('.item').forEach(item => item.addEventListener('click', () => item.classList.toggle('selected')));
            document.getElementById('cyclamed-zone').addEventListener('click', (e) => { if(e.target.classList.contains('dropped-item')) e.target.remove(); else if (e.target.closest('.drop-zone')) moveSelectedItemsToZone(cyclamedZone, excludedZone); });
            document.getElementById('excluded-zone').addEventListener('click', (e) => { if(e.target.classList.contains('dropped-item')) e.target.remove(); else if (e.target.closest('.drop-zone')) moveSelectedItemsToZone(excludedZone, cyclamedZone); });
        }
        function moveSelectedItemsToZone(targetZone, otherZone) {
             itemsContainer.querySelectorAll('.item.selected').forEach(item => { const itemId=item.dataset.item, itemText=item.querySelector('p').textContent; const existingOther = otherZone.querySelector(`.dropped-item[data-item="${itemId}"]`); if(existingOther) existingOther.remove(); if (!targetZone.querySelector(`.dropped-item[data-item="${itemId}"]`)) { const dropped = document.createElement('div'); dropped.className='dropped-item'; dropped.dataset.item=itemId; dropped.textContent=itemText; dropped.addEventListener('click', ()=>dropped.remove()); targetZone.appendChild(dropped); } item.classList.remove('selected'); });
        }
        function validateStage1() {
            if(gameState.stageResults.stage1.completed) return; // Don't re-validate
            const droppedC = Array.from(cyclamedZone.querySelectorAll('.dropped-item')).map(el => el.dataset.item); const droppedE = Array.from(excludedZone.querySelectorAll('.dropped-item')).map(el => el.dataset.item); const allCount = droppedC.length + droppedE.length; const totalOrig = itemsContainer.querySelectorAll('.item').length; const correctC = ['medicament-plein', 'medicament-entame']; const allOrigData = Array.from(itemsContainer.querySelectorAll('.item')).map(el => el.dataset.item); const correctE = allOrigData.filter(i => !correctC.includes(i)); let errors = [];
            if (allCount < totalOrig) errors.push(`Tri incomplet (${totalOrig - allCount} restants).`); let correctCFound = 0; droppedC.forEach(i => { if (correctC.includes(i)) correctCFound++; else errors.push(`"${itemsContainer.querySelector(`.item[data-item='${i}'] p`).textContent}" incorrect dans ✅ MNU.`); }); if (correctCFound !== correctC.length && allCount === totalOrig) errors.push(`Manque ${correctC.length - correctCFound} item(s) dans ✅ MNU.`); let correctEFound = 0; droppedE.forEach(i => { if (correctE.includes(i)) correctEFound++; else errors.push(`"${itemsContainer.querySelector(`.item[data-item='${i}'] p`).textContent}" incorrect dans ❌ Exclus.`); }); if (correctEFound !== correctE.length && allCount === totalOrig) errors.push(`Manque ${correctE.length - correctEFound} item(s) dans ❌ Exclus.`);

            if (errors.length === 0) {
                gameState.stageResults.stage1.correctItemsCount = correctC.length;
                stage1Feedback.textContent = `Bravo ! Tri parfait.`;
                // Append clue
                 stage1Feedback.innerHTML += '<br><span class="clue">Indice Code Final: Le <strong>nombre d\'items</strong> corrects (✅) est votre premier chiffre.</span>';
                stage1Feedback.className = 'feedback success';
                stage1Feedback.style.display = 'block';
                gameState.stageResults.stage1.completed = true;
                 clearInterval(gameState.helpCheckInterval); // Stop help check
                document.querySelector('#stage1 .regulatory-info')?.classList.add('visible');
                validateStage1Button.style.display = 'none';
                nextStageContainer1.style.display = 'block';
                nextStageBtn1.disabled = false;
            } else {
                stage1Feedback.textContent = `Erreurs : ${errors.join(' ')}`;
                stage1Feedback.className = 'feedback error';
                stage1Feedback.style.display = 'block';
                 // Increment failures and check help conditions
                 gameState.stageResults.stage1.failures++;
                 checkHelpConditionsAfterFailure('stage1');
            }
        }

        // == Stage 2 & 4: Card Selection Logic ==
        function initCardSelection() {
            // Handles single-choice (Stage 2 Producer, Stage 4 Target/Nature)
            // and multi-choice (Stage 2 Obligations) card selections
            document.querySelectorAll('.card-container').forEach(cont => {
                // Exclude Stage 3 container from this generic logic
                if (cont.id === 'available-logistics-steps') return;

                const multi = cont.id === 'obligation-cards'; // Only obligations are multi-select here
                cont.querySelectorAll('.card').forEach(card => card.addEventListener('click', () => {
                     // Don't process clicks if the stage is already validated (e.g., via backdoor)
                     const stageId = card.closest('.stage')?.id;
                     if (stageId && gameState.stageResults[stageId]?.completed) return;

                    if (!multi) {
                        // Single choice: deselect others in the same container
                        cont.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected'); // Select the clicked one
                    } else {
                        // Multi choice: toggle selection
                        card.classList.toggle('selected');
                    }
                    // REMOVED: updateLogisticsMapVisualization(); call no longer needed here
                }));
            });
        }
        function validateStage2() {
             if(gameState.stageResults.stage2.completed) return; // Don't re-validate
            const selP = producerCardsContainer.querySelector('.card.selected'); const selO = Array.from(obligationCardsContainer.querySelectorAll('.card.selected')).map(c => c.dataset.card); const correctP = 'exploitant'; const correctO = ['financer', 'adherer', 'eco-concevoir']; let pOk = selP?.dataset.card === correctP; let oOk = selO.length === correctO.length && correctO.every(ob => selO.includes(ob)); gameState.stageResults.stage2.producerCorrect=pOk; gameState.stageResults.stage2.obligationsCorrect=oOk;

            if (pOk && oOk) {
                gameState.stageResults.stage2.keyLetter = 'F'; // First letter of 'Financer'
                stage2Feedback.textContent = 'Excellent ! Producteur et obligations identifiés.';
                 // Append clue
                 stage2Feedback.innerHTML += '<br><span class="clue">Indice Mot de Passe: La <strong>première lettre</strong> de l\'obligation de financement est votre première lettre.</span>';
                stage2Feedback.className = 'feedback success';
                stage2Feedback.style.display = 'block';
                gameState.stageResults.stage2.completed = true;
                clearInterval(gameState.helpCheckInterval); // Stop help check
                document.querySelector('#stage2 .regulatory-info')?.classList.add('visible');
                validateStage2Button.style.display = 'none'; // Hide button
                 // Disable cards in this stage
                producerCardsContainer.querySelectorAll('.card').forEach(c => c.style.pointerEvents = 'none');
                obligationCardsContainer.querySelectorAll('.card').forEach(c => c.style.pointerEvents = 'none');
                nextStageContainer2.style.display = 'block';
                nextStageBtn2.disabled = false;
            } else {
                let fb = 'Vérifiez. '; if (!pOk) fb += 'Producteur incorrect. '; if (!oOk) fb += 'Obligations incorrectes/incomplètes.';
                stage2Feedback.textContent = fb; stage2Feedback.className = 'feedback error'; stage2Feedback.style.display = 'block';
                 // Increment failures and check help conditions
                 gameState.stageResults.stage2.failures++;
                 checkHelpConditionsAfterFailure('stage2');
            }
        }

        // == Stage 3: Sequential Logistics ==

        // NEW: Handle clicks on available step cards in Stage 3
        function initStage3CardClicks() {
            if (availableLogisticsStepsContainer) {
                availableLogisticsStepsContainer.addEventListener('click', function(event) {
                    const clickedCard = event.target.closest('.card');
                    // Only act if in Stage 3 and stage is not completed
                    if (clickedCard && gameState.currentStage === 'stage3' && !gameState.stageResults.stage3.completed) {
                        const stepId = clickedCard.dataset.stepId;
                        // Only add if not already in sequence
                        if (stepId && !gameState.stageResults.stage3.builtSequence.includes(stepId)) {
                            addStepToSequence(stepId);
                        } else if (stepId) {
                            // If already in sequence, maybe provide feedback or just do nothing
                            console.log(`Étape "${stepId}" déjà dans la séquence.`);
                        }
                    }
                });
            }
        }


        // NEW & UPDATED: Add a step to the user's built sequence and update card style
        function addStepToSequence(stepId) {
            if (gameState.stageResults.stage3.completed) return; // Prevent adding after completion
            gameState.stageResults.stage3.builtSequence.push(stepId);

            // Update the corresponding card's appearance
            const cardElement = availableLogisticsStepsContainer.querySelector(`.card[data-step-id='${stepId}']`);
            if (cardElement) {
                cardElement.classList.add('step-in-sequence');
            }

            updateBuiltSequenceDisplay();
        }

        // NEW & UPDATED: Remove a step and update card style
        function removeStepFromSequence(stepId) {
            if (gameState.stageResults.stage3.completed) return; // Prevent removal after completion
            gameState.stageResults.stage3.builtSequence = gameState.stageResults.stage3.builtSequence.filter(id => id !== stepId);

            // Update the corresponding card's appearance
            const cardElement = availableLogisticsStepsContainer.querySelector(`.card[data-step-id='${stepId}']`);
            if (cardElement) {
                cardElement.classList.remove('step-in-sequence');
            }

            updateBuiltSequenceDisplay();
        }

        // NEW & UPDATED: Clear the entire built sequence and reset card styles
        function clearBuiltSequence() {
            if (gameState.stageResults.stage3.completed) return; // Prevent clearing after completion

             // Reset appearance of all available cards
            availableLogisticsStepsContainer.querySelectorAll('.card.step-in-sequence').forEach(card => {
                card.classList.remove('step-in-sequence');
            });

            gameState.stageResults.stage3.builtSequence = [];
            updateBuiltSequenceDisplay();
            // Hide feedback when clearing
            stage3Feedback.style.display = 'none';
            stage3Feedback.textContent = '';
            stage3Feedback.className = 'feedback'; // Reset class
        }


        // NEW & UPDATED: Update the visual display (<ol>) of the built sequence
        function updateBuiltSequenceDisplay() {
            if (!builtSequenceList) return;

            builtSequenceList.innerHTML = ''; // Clear the current list display
            gameState.stageResults.stage3.builtSequence.forEach((stepId) => { // We don't need index for text content anymore
                const listItem = document.createElement('li');
                // Find the corresponding card to get its text content
                const card = availableLogisticsStepsContainer.querySelector(`.card[data-step-id='${stepId}']`);
                // Use card text if found, otherwise just the ID
                listItem.textContent = card ? card.textContent : stepId;
                listItem.style.cursor = 'pointer';
                listItem.title = "Cliquez pour retirer cette étape"; // Tooltip for usability
                // Add event listener directly to the li to remove the step
                listItem.addEventListener('click', () => removeStepFromSequence(stepId));

                // Add class for styling selected steps in the list
                listItem.classList.add('step-selected');

                builtSequenceList.appendChild(listItem);
            });

            // Enable/disable the validation button based on whether the sequence has items
             if (validateStage3Button) {
                 validateStage3Button.disabled = gameState.stageResults.stage3.builtSequence.length === 0 || gameState.stageResults.stage3.completed;
             }
             // Also enable/disable clear button
             if (clearSequenceButton) {
                clearSequenceButton.disabled = gameState.stageResults.stage3.builtSequence.length === 0 || gameState.stageResults.stage3.completed;
             }
        }


        // NEW: Shuffle the order of available step cards in Stage 3
        function shuffleAvailableLogisticsSteps() {
            const container = availableLogisticsStepsContainer;
            if (!container) return;
            const cards = Array.from(container.querySelectorAll('.card'));
            // Fisher-Yates (Knuth) Shuffle
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]]; // Swap elements
            }
            // Re-append cards in the new shuffled order
            container.innerHTML = ''; // Clear existing cards
            cards.forEach(card => container.appendChild(card));
            console.log("Available logistics steps display order shuffled.");
        }

        // REWRITTEN & UPDATED: Validate the built sequence in Stage 3
        function validateStage3() {
             if(gameState.stageResults.stage3.completed) return; // Don't re-validate
            const builtSequence = gameState.stageResults.stage3.builtSequence;
            let sequenceIsCorrect = false;

            // Compare the built sequence array with the correct sequence array
            if (builtSequence.length === correctLogisticsSequence.length) {
                sequenceIsCorrect = builtSequence.every((step, index) => step === correctLogisticsSequence[index]);
            }

            gameState.stageResults.stage3.sequenceCorrect = sequenceIsCorrect; // Update game state

            if (sequenceIsCorrect) {
                stage3Feedback.textContent = 'Parfait ! La séquence chronologique est correcte.';
                 // Append clue - MODIFIED for new logic
                 stage3Feedback.innerHTML += '<br><span class="clue">Indice Code Final: Le <strong>numéro de l\'article</strong> (L.541-??) sur la REP dans le Code de l\'Env. est nécessaire.</span>';
                stage3Feedback.className = 'feedback success';
                stage3Feedback.style.display = 'block';
                gameState.stageResults.stage3.completed = true; // Mark stage as completed
                 clearInterval(gameState.helpCheckInterval); // Stop help check
                document.querySelector('#stage3 .regulatory-info')?.classList.add('visible'); // Show info box

                // Disable interactions for this stage now that it's correct
                validateStage3Button.disabled = true;
                clearSequenceButton.disabled = true;
                if (availableLogisticsStepsContainer) availableLogisticsStepsContainer.style.pointerEvents = 'none'; // Disable clicking available cards
                if (builtSequenceList) builtSequenceList.style.pointerEvents = 'none'; // Disable removing steps from list

                // Show and enable the "Next Stage" button
                nextStageContainer3.style.display = 'block';
                nextStageBtn3.disabled = false;
            } else {
                // UPDATED: Simplified error message, NO auto-clear
                let feedbackMessage = "Incorrect. Vérifiez la séquence.";

                stage3Feedback.textContent = feedbackMessage;
                stage3Feedback.className = 'feedback error';
                stage3Feedback.style.display = 'block';

                 // Increment failures and check help conditions
                 gameState.stageResults.stage3.failures++;
                 checkHelpConditionsAfterFailure('stage3');
                // REMOVED: clearBuiltSequence(); - Sequence stays for correction
            }
        }


        // == Stage 4: Eco-organisme ==
        function validateStage4() {
             if(gameState.stageResults.stage4.completed) return; // Don't re-validate
            const tgt=collectionTargetContainer.querySelector('.card.selected'); const nat=ecoOrgNatureContainer.querySelector('.card.selected'); const name=ecoOrgNameInput.value.trim().toUpperCase();
            const correctTgt='70'; const correctNat='non-lucratif'; const correctName='CYCLAMED';
            let tgtOk=tgt?.dataset.target===correctTgt; let natOk=nat?.dataset.nature===correctNat; let nameOk=name===correctName;
            gameState.stageResults.stage4.collectionTarget=tgtOk?correctTgt:''; gameState.stageResults.stage4.ecoOrgNatureCorrect=natOk; gameState.stageResults.stage4.ecoOrgNameCorrect=nameOk;
            gameState.stageResults.stage4.ecoOrgName = (tgtOk && natOk && nameOk) ? correctName : '';

            if(tgtOk && natOk && nameOk){
                stage4Feedback.textContent = 'Excellent ! Infos correctes.';
                 // Append clue
                 stage4Feedback.innerHTML += '<br><span class="clue">Indices Code/Mdp: Le <strong>pourcentage objectif</strong> (%) et le <strong>nom</strong> de l\'éco-organisme complètent les codes.</span>';
                stage4Feedback.className = 'feedback success'; stage4Feedback.style.display = 'block';
                gameState.stageResults.stage4.completed=true;
                 clearInterval(gameState.helpCheckInterval); // Stop help check
                document.querySelector('#stage4 .regulatory-info')?.classList.add('visible');

                 // Disable interactions
                 validateStage4Button.style.display = 'none'; // Hide button
                 collectionTargetContainer.querySelectorAll('.card').forEach(c => c.style.pointerEvents = 'none');
                 ecoOrgNatureContainer.querySelectorAll('.card').forEach(c => c.style.pointerEvents = 'none');
                 ecoOrgNameInput.disabled = true;

                // Check if data from previous stages is available to calculate final codes
                if(gameState.stageResults.stage1.correctItemsCount > 0 && gameState.stageResults.stage2.keyLetter){
                    // MODIFIED: Calculate final codes using 10 instead of 27
                    gameState.finalCode=`${gameState.stageResults.stage1.correctItemsCount}${correctTgt}10`;
                    gameState.finalPassword=`${gameState.stageResults.stage2.keyLetter}${correctName}`;
                    console.log("Code Final:", gameState.finalCode, "Mdp:", gameState.finalPassword);
                    updateFinalStageInfoDisplay(); // Update the display in the final stage info box
                    nextStageContainer4.style.display = 'block';
                    nextStageBtn4.disabled = false;
                } else {
                    // This case should ideally not happen if stages are done sequentially or skipped correctly
                    console.error("Manque infos E1/E2 pour calcul final.");
                    stage4Feedback.textContent += "\nErreur interne: Impossible de calculer le code final (données E1/E2 manquantes). Vérifiez les étapes précédentes.";
                    stage4Feedback.className = 'feedback error'; // Change feedback to error
                }
            } else {
                let fb='Vérifiez. '; if(!tgtOk) fb+='Objectif incorrect. '; if(!natOk) fb+='Statut incorrect. '; if(!nameOk) fb+='Nom incorrect.';
                stage4Feedback.textContent=fb; stage4Feedback.className='feedback error'; stage4Feedback.style.display='block';
                 // Increment failures and check help conditions
                 gameState.stageResults.stage4.failures++;
                 checkHelpConditionsAfterFailure('stage4');
            }
        }

        // == Final Stage: Validation ==
        function validateFinal() {
            const code=finalCodeInput.value.trim(); const pwd=finalPasswordInput.value.trim().toUpperCase(); // Convert input password to uppercase for comparison

            // Ensure final codes have been calculated (should happen in validateStage4 or skipStage)
            if(!gameState.finalCode || !gameState.finalPassword){
                finalFeedback.textContent='Erreur: Codes finaux non générés. Assurez-vous d\'avoir validé correctement les étapes précédentes (surtout Etape 4).';
                finalFeedback.className='feedback error'; finalFeedback.style.display='block';

                // Attempt to recalculate if prerequisite data is available (e.g., if backdoor was used partially)
                if (gameState.stageResults.stage1.correctItemsCount > 0 &&
                    gameState.stageResults.stage4.collectionTarget &&
                    gameState.stageResults.stage2.keyLetter &&
                    gameState.stageResults.stage4.ecoOrgName) {
                     // MODIFIED: Use 10 in recalculation
                     gameState.finalCode = `${gameState.stageResults.stage1.correctItemsCount}${gameState.stageResults.stage4.collectionTarget}10`;
                     gameState.finalPassword = `${gameState.stageResults.stage2.keyLetter}${gameState.stageResults.stage4.ecoOrgName}`;
                     updateFinalStageInfoDisplay(); // Update display with recalculated codes
                     finalFeedback.textContent += ' (Codes recalculés, veuillez réessayer.)';
                     console.warn("Recalculated final codes due to missing state on final validation attempt.");
                 } else {
                     console.error("Cannot recalculate final codes - missing prerequisite data.");
                 }
                return; // Stop validation
             }

             // Compare entered codes with stored correct codes
             if(code === gameState.finalCode && pwd === gameState.finalPassword){
                 finalFeedback.textContent='Accès autorisé ! Système restauré !';
                 finalFeedback.className='feedback success'; finalFeedback.style.display='block';
                 clearInterval(gameState.timerInterval); // Stop the timer
                 clearInterval(gameState.helpCheckInterval); // Stop help check just in case

                 // Calculate time taken
                 const timeE = gameState.totalGameTime - gameState.timeRemaining;
                 const minT = Math.floor(timeE / (60 * 1000));
                 const secT = Math.floor((timeE % (60 * 1000)) / 1000);
                 if(timeTakenDisplay) timeTakenDisplay.textContent=`${minT} min ${secT} sec`;

                 // Delay before showing success screen
                 setTimeout(() => {
                     // Populate certificate details
                     teamNameDisplayCert.textContent=gameState.teamName;
                     timeRemainingDisplay.textContent=timerElement.textContent; // Show remaining time
                     if (participantListCert) {
                         participantListCert.innerHTML = ''; // Clear previous list
                         if (gameState.participants.length > 0) {
                             gameState.participants.forEach(name => {
                                 const li = document.createElement('li');
                                 li.textContent = name;
                                 participantListCert.appendChild(li);
                              });
                             document.getElementById('participants-section-cert').style.display = 'block'; // Show participant section
                         } else {
                             document.getElementById('participants-section-cert').style.display = 'none'; // Hide if no participants
                         }
                     }
                     showStage('success'); // Transition to success screen
                 }, 1500); // 1.5 second delay
             } else {
                 // Incorrect codes entered
                 finalFeedback.textContent='Accès refusé. Code ou Mot de Passe incorrect.';
                 finalFeedback.className='feedback error'; finalFeedback.style.display='block';
                 // Note: Failures are not tracked on the final stage for help button purposes
             }
         }

        // --- Game Reset ---
        function resetGame() {
            // Reset core game state
            gameState.teamName=''; gameState.participants = []; gameState.startTime=null; gameState.timeRemaining=gameState.totalGameTime;
            clearInterval(gameState.timerInterval);
            clearInterval(gameState.helpCheckInterval); // Clear help interval
            gameState.currentStage='intro';
            gameState.currentStageStartTime = null; // Reset stage timer

            // Reset results for all stages, including failures
            gameState.stageResults = {
                stage1: { completed: false, correctItemsCount: 0, failures: 0 },
                stage2: { completed: false, producerCorrect: false, obligationsCorrect: false, keyLetter: '', failures: 0 },
                stage3: { completed: false, builtSequence: [], sequenceCorrect: false, failures: 0 },
                stage4: { completed: false, collectionTarget: '', ecoOrgNatureCorrect: false, ecoOrgNameCorrect: false, ecoOrgName: '', failures: 0 }
            };
            gameState.finalCode=''; gameState.finalPassword='';

            // Reset UI elements
            if (introTitleElement) introTitleElement.style.display = '';
            if (teamNameGroup) teamNameGroup.style.display = '';
            if (participantsGroup) participantsGroup.style.display = '';
            if (startGameButton) startGameButton.style.display = '';
            teamNameInput.value=''; participantNamesInput.value = ''; teamNameDisplay.textContent='Équipe: Non définie';
            finalCodeInput.value=''; finalPasswordInput.value=''; ecoOrgNameInput.value='';

            // Clear feedback messages and remove clue spans
            document.querySelectorAll('.feedback').forEach(el=>{
                el.textContent='';
                el.style.display='none';
                el.className='feedback';
                const clueSpan = el.querySelector('.clue');
                if(clueSpan) clueSpan.remove();
            });


            // Deselect items/cards
            document.querySelectorAll('.card.selected, .item.selected').forEach(el=>el.classList.remove('selected'));

             // Reset Stage 3 card styles
            if (availableLogisticsStepsContainer) {
                availableLogisticsStepsContainer.querySelectorAll('.card.step-in-sequence').forEach(card => {
                    card.classList.remove('step-in-sequence');
                });
            }

            // Reset Stage 1 zones
            cyclamedZone.innerHTML=''; excludedZone.innerHTML='';

            // Reset Stage 3 UI
            clearBuiltSequence(); // Clears the list and updates display/buttons
            shuffleAvailableLogisticsSteps(); // Re-shuffle available steps

            // Hide regulatory info boxes
            document.querySelectorAll('.regulatory-info').forEach(box => box.classList.remove('visible'));

             // Reset validation buttons visibility and state
             [validateStage1Button, validateStage2Button, validateStage3Button, validateStage4Button].forEach(btn => {
                 if(btn){
                     btn.style.display = 'inline-block'; // Make visible
                     btn.disabled = false; // Enable (Stage 3 button will be disabled by updateBuiltSequenceDisplay if list is empty)
                 }
             });
              if (validateStage3Button) validateStage3Button.disabled = true; // Explicitly disable Stage 3 validation as sequence starts empty
             // Reset input fields and card interactivity
              ecoOrgNameInput.disabled = false;
              [producerCardsContainer, obligationCardsContainer, collectionTargetContainer, ecoOrgNatureContainer, availableLogisticsStepsContainer, builtSequenceList].forEach(container => {
                  if (container) {
                      container.style.pointerEvents = 'auto'; // Re-enable clicks
                      if (container.querySelectorAll) {
                          container.querySelectorAll('.card').forEach(c => c.style.pointerEvents = 'auto');
                      }
                  }
              });


             // Hide "Next Stage" containers and disable buttons
             [nextStageContainer1, nextStageContainer2, nextStageContainer3, nextStageContainer4].forEach(cont => { if(cont) cont.style.display = 'none'; });
             [nextStageBtn1, nextStageBtn2, nextStageBtn3, nextStageBtn4].forEach(btn => { if(btn){ btn.disabled = true; const textNode = Array.from(btn.childNodes).find(node => node.nodeType === Node.TEXT_NODE); if(textNode) textNode.textContent = "Passer à l'étape suivante"; }});

            // Clear certificate participant list
            if (participantListCert) { participantListCert.innerHTML = ''; document.getElementById('participants-section-cert').style.display = 'none';}

             // Hide Help and Previous buttons
             showHelpButton.style.display = 'none';
             prevStageButton.style.display = 'none';
             prevStageButton.disabled = true;


            // Update displays
            updateFinalStageInfoDisplay(); // Clear final code calculation display
            resetTimerDisplay(); // Reset timer display to initial value
            updateProgress(); // Reset progress bar
            updateStageDots(); // Reset stage indicators

            // Show the intro screen
            showStage('intro');
        }

        // --- Certificate Download ---
        function handleDownloadCertificatePDF() {
            const certificateElement = certificateContentElement;
            const originalButtonText = downloadPdfButton.innerHTML;
            const teamName = gameState.teamName.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'equipe';
            const filename = `Certificat-Conformite-MNU-${teamName}.pdf`;

            if (typeof html2canvas === 'undefined' || typeof jspdf === 'undefined') {
                alert("Erreur: Impossible de charger les librairies nécessaires pour générer le PDF.");
                return;
            }
            const { jsPDF } = jspdf;

             downloadPdfButton.disabled = true;
             downloadPdfButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';

             // Use html2canvas to capture the certificate element
             html2canvas(certificateElement, {
                 scale: 2, // Improve resolution
                 useCORS: true, // Handle potential cross-origin issues if using external images (though unlikely here)
                 backgroundColor: '#f8f9fa' // Ensure background is captured
             }).then(canvas => {
                 try {
                     const imgData = canvas.toDataURL('image/png'); // Get image data from canvas
                     const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' }); // Create A4 PDF in portrait

                     // Calculate image dimensions to fit A4 page with margins
                     const pdfWidth = pdf.internal.pageSize.getWidth();
                     const pdfHeight = pdf.internal.pageSize.getHeight();
                     const canvasWidth = canvas.width;
                     const canvasHeight = canvas.height;
                     const canvasRatio = canvasWidth / canvasHeight;
                     const margin = 15; // mm margin
                     const usableWidth = pdfWidth - 2 * margin;
                     const usableHeight = pdfHeight - 2 * margin;

                     let imgWidth = usableWidth;
                     let imgHeight = imgWidth / canvasRatio;

                     // If height exceeds usable height, resize based on height instead
                     if (imgHeight > usableHeight) {
                         imgHeight = usableHeight;
                         imgWidth = imgHeight * canvasRatio;
                     }

                     // Calculate position to center the image
                     const xPos = margin + (usableWidth - imgWidth) / 2;
                     const yPos = margin + (usableHeight - imgHeight) / 2;

                     // Add the image to the PDF
                     pdf.addImage(imgData, 'PNG', xPos, yPos, imgWidth, imgHeight);

                     // Save the PDF
                     pdf.save(filename);

                 } catch (error) {
                     console.error("Erreur lors de la génération du PDF:", error);
                     alert("Une erreur est survenue pendant la génération du PDF.");
                 } finally {
                     // Restore button state regardless of success/failure
                      downloadPdfButton.disabled = false;
                      downloadPdfButton.innerHTML = originalButtonText;
                 }
             }).catch(error => {
                 console.error("Erreur html2canvas:", error);
                 alert("Une erreur est survenue lors de la capture du certificat pour le PDF.");
                 downloadPdfButton.disabled = false;
                 downloadPdfButton.innerHTML = originalButtonText;
             });
        }

        // Initialize on load
        window.addEventListener('load', initGame);

    </script>
</body>
</html>
