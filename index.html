<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALERTE MNU : Mission conformité</title>
    <style>
        :root {
            --primary: #e63946; /* Rouge Alerte */
            --secondary: #457b9d; /* Bleu Ministère */
            --light: #f1faee; /* Fond Clair */
            --dark: #1d3557; /* Bleu Foncé Texte */
            --success: #2a9d8f; /* Vert Succès */
            --warning: #e9c46a; /* Jaune Avertissement */
            --danger: #e76f51; /* Orange Danger */
            --gray: #6c757d; /* Gris */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary);
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative; /* Added for backdoor button positioning */
        }

        h1 {
             font-size: 1.8rem;
             margin-bottom: 5px;
        }
        header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        h2, h3 {
            margin-bottom: 15px;
            color: var(--dark);
        }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.2rem; }


        .timer-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px; /* Slightly reduced gap */
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            background-color: var(--dark);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: inline-block;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s;
            min-width: 100px; /* Ensure consistent width */
            text-align: center;
            flex-shrink: 0; /* Prevent timer shrinking */
        }

        .timer.warning {
            background-color: var(--warning);
            color: var(--dark);
        }

        .timer.danger {
            background-color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .stage {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none; /* Initially hidden */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .stage.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .intro { /* Keep intro visible initially */
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .btn {
            display: inline-block;
            background-color: var(--secondary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-decoration: none; /* Remove underline if used as link */
            text-align: center;
        }

        .btn:hover:not(:disabled) { /* Prevent hover effect when disabled */
            background-color: var(--dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:active:not(:disabled) { /* Prevent active effect when disabled */
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
         .btn:disabled {
             background-color: var(--gray);
             cursor: not-allowed;
             transform: none;
             box-shadow: 0 2px 4px rgba(0,0,0,0.05);
             opacity: 0.65; /* Indicate disabled state */
         }


        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-secondary { background-color: var(--secondary); }
        /* Removed btn-help */

        .item-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .item {
            background-color: var(--light);
            border: 2px solid var(--secondary);
            border-radius: 5px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            width: calc(25% - 12px); /* Adjusted for gap */
            text-align: center;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Ensure content aligns well */
        }

        .item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .item.selected {
            border-color: var(--success);
            background-color: rgba(42, 157, 143, 0.1);
            box-shadow: 0 0 0 3px var(--success);
        }

        .item img {
            max-width: 80%; /* Adjust as needed */
            height: 50px; /* Fixed height */
            object-fit: contain; /* Maintain aspect ratio */
            margin: 0 auto 10px auto; /* Center image */
            border-radius: 3px;
        }
        .item p {
            font-size: 0.9rem;
        }

        .drop-zones {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }

        .drop-zone {
            border: 2px dashed var(--secondary);
            border-radius: 5px;
            padding: 20px;
            flex: 1;
            min-height: 200px;
            background-color: rgba(69, 123, 157, 0.05);
            transition: all 0.3s;
        }

        .drop-zone:hover {
            background-color: rgba(69, 123, 157, 0.1);
            border-color: var(--primary);
        }

        .drop-zone h3 {
            text-align: center;
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .dropped-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .dropped-item {
            background-color: var(--light);
            border: 1px solid var(--secondary);
            border-radius: 5px;
            padding: 8px 12px;
            width: calc(50% - 5px);
            text-align: center;
            font-size: 0.85rem;
            cursor: pointer; /* Indicate it's clickable */
            transition: background-color 0.2s;
        }
        .dropped-item:hover {
            background-color: rgba(230, 57, 70, 0.1); /* Light red */
        }


        .feedback {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none; /* Initially hidden */
            animation: fadeIn 0.5s;
            border-width: 1px;
            border-style: solid;
        }
         /* Style for clue text in feedback - REMOVED */
         /* .feedback .clue { ... } */


        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .feedback.success {
            background-color: rgba(42, 157, 143, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .feedback.error {
            background-color: rgba(231, 111, 81, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        .card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .card {
            background-color: white;
            border: 1px solid var(--gray);
            border-radius: 5px;
            padding: 15px;
            /* Ajustement pour Stage 3 : légèrement plus large */
            width: calc(33.333% - 10px);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            font-size: 0.95rem;
        }
        /* Spécifique pour les cartes de l'étape 3 disponibles */
        #available-logistics-steps .card {
            width: calc(50% - 8px); /* 2 par ligne pour plus de clarté */
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary);
        }

        /* Style pour les cartes sélectionnées dans Stage 2 & 4 */
        .card.selected {
            border-color: var(--success);
            background-color: rgba(42, 157, 143, 0.1);
            box-shadow: 0 0 0 2px var(--success);
        }

        /* Style pour les cartes sélectionnées dans Stage 2 & 4 */
        .card.selected::after {
            content: "✓";
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--success);
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* NOUVEAU: Style pour les cartes disponibles de l'Étape 3 qui sont dans la séquence */
        #available-logistics-steps .card.step-in-sequence {
            background-color: rgba(42, 157, 143, 0.1); /* Léger fond vert */
            border-color: var(--success);
            opacity: 0.7; /* Optionnel: Les rendre légèrement moins visibles */
            cursor: not-allowed; /* Indiquer qu'on ne peut pas recliquer dessus */
        }
        #available-logistics-steps .card.step-in-sequence:hover {
            /* Empêcher l'effet hover normal si la carte est déjà sélectionnée */
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }


        /* Styles pour la zone de séquence ordonnée (Stage 3) */
        .ordered-sequence-area {
             margin-top: 30px;
             background-color: #f8f9fa;
             padding: 20px;
             border-radius: 8px;
             border: 1px solid #eee;
        }
         #built-sequence-list {
             list-style-position: inside; /* Ensure OL numbers are inside */
             list-style-type: decimal; /* Explicitly set decimal numbering */
             border: 1px solid #ddd;
             padding: 15px 15px 5px 25px; /* Adjust left padding for numbers */
             border-radius: 5px;
             min-height: 50px;
             background-color: white; /* Fond blanc pour contraste */
             margin-bottom: 15px; /* Espace avant bouton 'clear' */
         }
         #built-sequence-list li {
             margin-bottom: 10px; /* Espace entre items */
             padding: 8px 10px;
             border-radius: 3px;
             cursor: pointer;
             transition: background-color 0.2s ease, border-color 0.2s ease;
             /* Ensure default marker styling is not overridden badly */
             display: list-item; /* Make sure it behaves like a list item */
             /* Default state - pas de couleur spécifique ici, mais on pourrait ajouter un style de base */
             background-color: var(--light); /* Utilisation d'une variable pour cohérence */
             border-left: 3px solid var(--secondary); /* Bordure bleue par défaut */
         }
         /* Conserve le style pour les éléments de la liste */
         #built-sequence-list li.step-selected {
            background-color: rgba(42, 157, 143, 0.15); /* Légèrement plus prononcé */
            border-left: 3px solid var(--success);
         }

         #built-sequence-list li:hover { /* Hover to remove */
             background-color: rgba(230, 57, 70, 0.1); /* Hover rouge léger */
             border-left-color: var(--danger); /* Indicate removal on hover */
         }
         #clear-sequence-btn {
             margin-top: 0; /* Enlevé le margin-top */
             font-size: 0.8rem;
             padding: 5px 10px;
         }

        /* SUPPRESSION des styles .map-container, .map-point, .map-line, .map-arrow */

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input[type="text"],
        .input-group textarea { /* Apply styles to textarea too */
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Ensure consistent font */
        }
        .input-group textarea {
            resize: vertical; /* Allow vertical resize */
            min-height: 60px; /* Minimum height */
        }

        .input-group input[type="text"]:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(69, 123, 157, 0.2);
        }

        /* Certificate Styles - Keep as is for capture */
        .certificate {
            background-color: #f8f9fa; /* Use non-transparent background for capture */
            border: 5px solid var(--success);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 30px auto 0 auto; /* Remove bottom margin for capture */
            max-width: 600px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            color: var(--dark); /* Ensure text color for capture */
        }
        /* Ensure colors are captured */
        .certificate h2 { color: var(--success); }
        .certificate #team-name-display-cert { color: var(--primary); }
        .certificate #time-remaining { color: var(--success); }
        .certificate #participants-section-cert h4 { color: var(--dark); }
        .certificate h3 { color: var(--dark); } /* Ensure Synthèse heading is dark */
        .certificate-seal { background-color: var(--success); color: white; }


        .certificate::before { /* Inner border */
            content: "";
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border: 2px dashed var(--success);
            border-radius: 5px;
            pointer-events: none;
        }

        .certificate h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }
        .certificate p {
             margin-bottom: 15px;
        }
        .certificate ul {
            list-style-position: inside;
            text-align: left;
            margin-top: 20px;
            padding-left: 20px; /* Indent list */
        }
         .certificate li {
             margin-bottom: 8px;
             font-size: 0.95rem;
         }
         /* Styles for Participants on Certificate */
         #participants-section-cert h4 {
             font-size: 1rem;
             margin-bottom: 5px;
         }
         #participant-list-cert {
             list-style: none !important;
             padding-left: 10px !important;
             margin-top: 0;
             font-style: italic;
         }
         #participant-list-cert li {
             margin-bottom: 3px;
             font-size: 0.9rem;
         }


        .certificate-seal {
            position: absolute;
            bottom: 25px;
            right: 25px;
            width: 90px; /* Larger seal */
            height: 90px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1rem;
            transform: rotate(-15deg);
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.2);
        }

        .hidden {
            display: none;
        }

        /* REMOVED MODAL STYLES */

        .progress-bar {
            height: 12px; /* Slightly thicker */
            background-color: #e9ecef;
            border-radius: 6px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.5s ease-in-out;
            border-radius: 6px;
        }

        .info-box {
            background-color: rgba(69, 123, 157, 0.05); /* Lighter blue */
            border-left: 5px solid var(--secondary);
            padding: 20px;
            margin: 25px 0;
            border-radius: 0 8px 8px 0;
             /* Add border styles that will be revealed */
             border-top: 1px solid #eee;
             border-bottom: 1px solid #eee;
             border-right: 1px solid #eee;
        }

        .info-box h3 {
            color: var(--secondary);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        /* Specific styling for legislative text */
         .info-box .leg-text {
            font-family: 'Courier New', Courier, monospace; /* Monospace for legal text maybe? Or keep default */
            font-size: 0.85rem;
            background-color: #ffffff; /* White background */
            border: 1px solid #eee;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            white-space: pre-wrap; /* Preserve line breaks from HTML */
            color: #333; /* Darker gray for text */
            display: block; /* Ensure it takes block space */
            max-height: 150px; /* Limit height and make scrollable if needed */
            overflow-y: auto; /* Add scroll if text too long */
        }

        .info-box p {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .info-box p strong {
             color: var(--dark);
        }

        .info-box p:last-child {
            margin-bottom: 0;
        }
         /* Style for Font Awesome icons */
        .info-box h3 .fas {
            margin-right: 8px;
            color: var(--secondary);
        }
        /* Style for result code in final stage info box - REMOVED as code is not displayed */
        /* #final-stage .info-box code { ... } */

         /* Additional styles for the final stage info box instructions */
        #final-stage .info-box ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-top: 5px;
        }
        #final-stage .info-box li {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }


        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .stage-number {
            background-color: var(--primary);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.3rem;
            margin-right: 15px;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .stage-title {
            display: flex;
            align-items: center;
        }
         .stage-title h2 {
             margin-bottom: 0; /* Remove margin from h2 inside */
         }

        .stage-time {
            background-color: var(--gray);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            white-space: nowrap; /* Prevent wrapping */
        }

        .team-info {
            background-color: white;
            border-radius: 5px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eee;
        }

        .team-name {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .stage-indicator {
            display: flex;
            gap: 8px;
        }

        .stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ddd;
            transition: background-color 0.3s;
        }

        .stage-dot.active {
            background-color: var(--warning); /* Yellow for active */
        }

        .stage-dot.completed {
            background-color: var(--success); /* Green for completed */
        }

         /* Backdoor button style */
        #backdoor-btn {
            position: absolute;
            top: 5px; /* Adjust position */
            right: 5px; /* Adjust position */
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.2); /* Very subtle */
            cursor: pointer;
            font-size: 1.2rem; /* Smaller */
            padding: 5px;
            z-index: 10; /* Ensure it's clickable */
            transition: color 0.3s;
        }
        #backdoor-btn:hover {
            color: rgba(255, 255, 255, 0.6); /* Less subtle on hover */
        }

        /* Styles for Hiding/Showing Regulatory Info */
        .regulatory-info {
            display: block; /* Keep block for layout calculation */
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity 0.6s ease-out, max-height 0.6s ease-out, margin-top 0.6s ease-out, padding-top 0.6s ease-out, padding-bottom 0.6s ease-out, border-width 0.6s ease-out;
            margin-top: 0 !important; /* Collapse margin when hidden */
            padding-top: 0 !important; /* Collapse padding when hidden */
            padding-bottom: 0 !important;
            border-left-width: 0 !important; /* Hide border when collapsed */
            border-top-width: 0 !important;
            border-bottom-width: 0 !important;
            border-right-width: 0 !important;
             border-color: transparent !important; /* Hide color too */
        }

        .regulatory-info.visible {
            opacity: 1;
            max-height: 1000px; /* Large enough to fit content */
            margin-top: 25px !important; /* Restore original margin */
            padding-top: 20px !important; /* Restore original padding */
            padding-bottom: 20px !important;
            border-left-width: 5px !important; /* Restore border */
            border-top-width: 1px !important;
            border-bottom-width: 1px !important;
            border-right-width: 1px !important;
            border-style: solid !important; /* Ensure border style is applied */
             border-color: #eee #eee #eee var(--secondary) !important; /* Restore border colors */
            border-radius: 0 8px 8px 0 !important; /* Restore border-radius */
        }

        /* REMOVED Countdown timer related CSS */


        @media (max-width: 992px) {
             .item { width: calc(33.333% - 10px); }
             .card { width: calc(50% - 8px); } /* Applied to all card containers */
             #available-logistics-steps .card { width: calc(50% - 8px); } /* Explicitly for stage 3 */
        }


        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            .item { width: calc(50% - 8px); } /* 2 items per row */
            .card { width: calc(50% - 8px); }
            #available-logistics-steps .card { width: calc(50% - 8px); } /* Still 2 per row on tablets */
            .drop-zones { flex-direction: column; }
            .certificate { padding: 25px; }
            .certificate-seal { width: 70px; height: 70px; font-size: 0.9rem; bottom: 15px; right: 15px; }
            .stage-header { align-items: flex-start; }
             .stage-title h2 { font-size: 1.3rem; }
             /* .map-container { height: 300px; } */ /* Removed */
        }

        @media (max-width: 480px) {
             h1 { font-size: 1.3rem; }
            .item { width: 100%; } /* 1 item per row */
            .card { width: 100%; } /* 1 card per row */
            #available-logistics-steps .card { width: 100%; } /* 1 card per row */
            .dropped-item { width: 100%; } /* Ensure dropped items stack */
            .timer { font-size: 1.5rem; padding: 8px 15px; }
            .stage-header { flex-direction: column; align-items: flex-start; }
            .stage-time { margin-top: 10px; }
            .stage-title h2 { font-size: 1.2rem; }
            .team-info { flex-direction: column; align-items: flex-start; gap: 10px; }
            /* Removed modal styling */
             .certificate { padding: 20px; }
             .certificate h2 { font-size: 1.5rem; }
              .certificate ul { padding-left: 5px; } /* Less indent on mobile */
             .certificate-seal { width: 60px; height: 60px; font-size: 0.8rem; }
             /* .map-container { height: 250px; } */ /* Removed */
             /* .map-point { width: 35px; height: 35px; font-size: 1.2rem; } */ /* Removed */
             .timer-container { gap: 5px; } /* Reduce gap for smaller screens */
        }

        /* Styles for Printing the Certificate - REMOVED/IGNORED FOR PDF */
        @media print {
            /* Styles here might interfere with html2canvas, better to rely on screen styles */
            /* Keeping @page for basic print layout if user manually prints */
             @page {
                size: A4;
                margin: 1.5cm; /* Standard margin */
            }
            /* Hide buttons when printing manually */
             #success > div:last-of-type { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ALERTE MNU : Mission conformité</h1>
            <p>Une mission critique pour sécuriser la filière des Médicaments Non Utilisés</p>
            <button id="backdoor-btn" title="Accès spécial">
                <i class="fas fa-door-open"></i>
            </button>
        </header>

        <div class="team-info">
            <div class="team-name" id="team-name-display">Équipe: Non définie</div>
            <div class="stage-indicator">
                <div class="stage-dot" data-stage="1"></div>
                <div class="stage-dot" data-stage="2"></div>
                <div class="stage-dot" data-stage="3"></div>
                <div class="stage-dot" data-stage="4"></div>
                <div class="stage-dot" data-stage="5"></div>
            </div>
        </div>

        <div class="timer-container">
            <div class="timer" id="timer">10:00</div>
            <!-- Previous Stage Button Added Here -->
            <button class="btn btn-secondary" id="prev-stage-btn" style="display: none;">Étape Précédente</button>
            <!-- REMOVED Help Button -->
        </div>

        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>

        <!-- Introduction -->
        <div class="stage intro active" id="intro">
            <h2 id="intro-title">Message urgent des ministères de la Santé et de l'Environnement</h2>
            <p><strong>🔊 Bip... Bip... Alerte Interministérielle !</strong></p>
            <p>Une <strong>faille critique</strong> menace la chaîne de gestion des Médicaments Non Utilisés (MNU). Risques sanitaires et environnementaux majeurs détectés !</p>
            <p>Vous êtes une <strong>cellule d'experts interministérielle</strong> dépêchée en urgence. Votre mission : auditer la filière en <strong>10 minutes chrono</strong>, identifier les non-conformités réglementaires (CSP, C. Env.) et <strong>restaurer l'intégrité du système</strong>.</p>
            <p>Le temps presse !</p>

            <div class="input-group" id="team-name-group">
                <label for="team-name">Nom de votre équipe d'experts :</label>
                <input type="text" id="team-name" placeholder="Entrez le nom de votre équipe">
            </div>
            <div class="input-group" id="participants-group">
                <label for="participant-names">Noms des participants (un par ligne) :</label>
                <textarea id="participant-names" rows="3" placeholder="Jean Dupont&#10;Marie Durand&#10;..."></textarea>
            </div>

            <button class="btn btn-primary" id="start-game">Commencer la mission (10 min)</button>
        </div>

        <!-- Stage 1: Le Tri Impossible à l'Officine -->
        <div class="stage" id="stage1">
            <div class="stage-header">
                <div class="stage-title">
                    <div class="stage-number">1</div>
                    <h2>Le Tri Impossible à l'Officine</h2>
                </div>
                <div class="stage-time">~3 minutes</div>
            </div>

            <p>Première étape : l'officine. Des patients ont rapporté divers objets. Conformément à la réglementation, déterminez précisément quels objets relèvent de la collecte spécifique des MNU par l'éco-organisme et lesquels sont exclus.</p>
            <p><strong>Cliquez sur les objets pour les sélectionner, puis cliquez sur la zone de destination (✅ MNU ou ❌ Exclus).</strong> Cliquez sur un objet dans une zone pour le retirer.</p>

            <h3>Objets rapportés par les particuliers :</h3>
            <div class="item-container" id="items-to-sort">
                 <div class="item" data-item="medicament-plein">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='10' y='10' width='80' height='40' rx='5' fill='%23fff' stroke='%23333' stroke-width='2'/><rect x='20' y='20' width='60' height='20' rx='2' fill='%23f8f9fa'/><text x='50' y='35' font-family='Arial' font-size='10' text-anchor='middle'>Médicament</text></svg>" alt="Boîte de médicaments">
                    <p>Boîte de médicaments (humain) non entamée</p>
                </div>
                <div class="item" data-item="medicament-entame">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='10' y='10' width='80' height='40' rx='5' fill='%23fff' stroke='%23333' stroke-width='2'/><rect x='20' y='20' width='60' height='20' rx='2' fill='%23f8f9fa'/><text x='50' y='35' font-family='Arial' font-size='10' text-anchor='middle'>Médicament</text><line x1='70' y1='10' x2='90' y2='30' stroke='%23e63946' stroke-width='2'/></svg>" alt="Boîte de médicaments entamée">
                    <p>Boîte de médicaments (humain) entamée</p>
                </div>
                <div class="item" data-item="seringue">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><line x1='20' y1='40' x2='80' y2='20' stroke='%23333' stroke-width='2'/><rect x='20' y='35' width='15' height='10' fill='%23fff' stroke='%23333' stroke-width='2'/><rect x='35' y='32' width='30' height='5' fill='%23f8f9fa' stroke='%23333' stroke-width='1'/><circle cx='75' cy='22' r='5' fill='none' stroke='%23333' stroke-width='1'/></svg>" alt="Seringue usagée">
                    <p>Seringue usagée (DASTRI)</p>
                </div>
                <div class="item" data-item="thermometre">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='45' y='10' width='10' height='40' rx='5' fill='%23fff' stroke='%23333' stroke-width='2'/><circle cx='50' cy='45' r='5' fill='%23e63946'/><line x1='50' y1='15' x2='50' y2='40' stroke='%23333' stroke-width='1'/><line x1='45' y1='20' x2='55' y2='20' stroke='%23333' stroke-width='1'/><line x1='45' y1='30' x2='55' y2='30' stroke='%23333' stroke-width='1'/></svg>" alt="Thermomètre au mercure">
                    <p>Thermomètre au mercure</p>
                </div>
                <div class="item" data-item="complement">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='20' y='10' width='60' height='40' rx='5' fill='%23fff' stroke='%23333' stroke-width='2'/><text x='50' y='35' font-family='Arial' font-size='8' text-anchor='middle'>Complément</text><text x='50' y='45' font-family='Arial' font-size='8' text-anchor='middle'>Alimentaire</text></svg>" alt="Complément alimentaire">
                    <p>Complément alimentaire</p>
                </div>
                <div class="item" data-item="emballage">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><path d='M20,10 L80,10 L80,50 L20,50 Z' fill='none' stroke='%23333' stroke-width='2' stroke-dasharray='5,5'/><text x='50' y='35' font-family='Arial' font-size='8' text-anchor='middle'>Emballage</text><text x='50' y='45' font-family='Arial' font-size='8' text-anchor='middle'>vide</text></svg>" alt="Emballage carton vide">
                    <p>Emballage carton vide de médicament</p>
                </div>
                <div class="item" data-item="notice">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='20' y='10' width='60' height='40' fill='%23fff' stroke='%23333' stroke-width='1'/><line x1='30' y1='20' x2='70' y2='20' stroke='%23333' stroke-width='1'/><line x1='30' y1='30' x2='70' y2='30' stroke='%23333' stroke-width='1'/><line x1='30' y1='40' x2='50' y2='40' stroke='%23333' stroke-width='1'/></svg>" alt="Notice de médicament">
                    <p>Notice de médicament (papier)</p>
                </div>
                <div class="item" data-item="veterinaire">
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='60' viewBox='0 0 100 60'><rect x='20' y='10' width='60' height='40' rx='5' fill='%23fff' stroke='%23333' stroke-width='2'/><text x='50' y='30' font-family='Arial' font-size='8' text-anchor='middle'>Médicament</text><text x='50' y='40' font-family='Arial' font-size='8' text-anchor='middle'>Vétérinaire</text><path d='M40,20 L45,15 L50,20 L55,15 L60,20' fill='none' stroke='%23333' stroke-width='1'/></svg>" alt="Médicament vétérinaire">
                    <p>Médicament vétérinaire</p>
                </div>
            </div>

            <div class="drop-zones">
                <div class="drop-zone" id="cyclamed-zone">
                    <h3>✅ Collecte MNU (Éco-organisme)</h3>
                    <div class="dropped-items"></div>
                </div>
                <div class="drop-zone" id="excluded-zone">
                    <h3>❌ Exclus MNU</h3>
                    <div class="dropped-items"></div>
                </div>
            </div>

            <button class="btn btn-primary" id="validate-stage1">Valider le tri</button>
            <div class="feedback" id="stage1-feedback"></div>
            <div class="info-box regulatory-info">
                <h3><i class="fas fa-book"></i> Textes applicables</h3>
                <p><strong>Article L. 5111-1 du Code de la santé publique :</strong></p>
                <p class="leg-text">"On entend par médicament à usage humain toute substance ou composition présentée comme possédant des propriétés curatives ou préventives à l'égard des maladies humaines, ainsi que toute substance ou composition pouvant être utilisée chez l'homme ou pouvant lui être administrée, en vue d'établir un diagnostic médical ou de restaurer, corriger ou modifier ses fonctions physiologiques en exerçant une action pharmacologique, immunologique ou métabolique."</p>
                <p><strong>Article R. 4211-23 du Code de la santé publique:</strong></p>
                <p class="leg-text">"IV.-Pour l'application de la présente section, on entend par : [...] 2° “ Médicaments non utilisés ”, les médicaments à usage humain inutilisés ou périmés détenus par les particuliers."</p>
                <p><strong>Produits non concernés :</strong></p>
                 <p class="leg-text">Sont exclus du champ des MNU (liste non exhaustive) :
- Les conditionnements primaires vides et secondaires (relevant de la REP emballages ménagers).
- Les dispositifs médicaux perforants des patients en auto-traitement (relevant de la filière DASTRI - Art. R. 1335-8-1 et suivants CSP).
- Les médicaments vétérinaires.
- Les produits de parapharmacie, cosmétiques, compléments alimentaires, etc. (non définis comme médicaments à usage humain).
- Les thermomètres, produits chimiques, etc.</p>
            </div>
            <div class="next-stage-container" id="next-stage-container-1" style="display: none; margin-top: 15px;">
                <button class="btn btn-success next-stage-btn" id="next-stage-1" disabled>
                     Passer à l'étape suivante
                </button>
            </div>
        </div>

        <!-- Stage 2: Le Producteur Amnésique -->
        <div class="stage" id="stage2">
            <div class="stage-header">
                <div class="stage-title">
                    <div class="stage-number">2</div>
                    <h2>Le Producteur Amnésique</h2>
                </div>
                <div class="stage-time">~2 minutes</div>
            </div>
            <p>Identifiez le "producteur" REP MNU et ses obligations fondamentales selon les textes.</p>
            <p><strong>Cliquez sur les bonnes réponses.</strong></p>
            <h3>Qui est le "producteur" REP pour les MNU?</h3>
            <div class="card-container" id="producer-cards">
                 <div class="card" data-card="fabricant">Le fabricant physique du médicament</div>
                <div class="card" data-card="exploitant">L'exploitant pharmaceutique</div>
                <div class="card" data-card="pharmacien">L'ensemble des pharmaciens d'officine</div>
                <div class="card" data-card="grossiste">Les grossistes-répartiteurs</div>
            </div>
            <h3>Quelles sont les obligations FONDAMENTALES du producteur?</h3>
            <div class="card-container" id="obligation-cards">
                 <div class="card" data-card="financer">Financer la filière (contribuer à gestion déchets)</div>
                <div class="card" data-card="adherer">Adhérer à un éco-organisme (ou système individuel)</div>
                <div class="card" data-card="collecter-physiquement">Organiser la collecte physique lui-même</div>
                <div class="card" data-card="eco-concevoir">Adopter une démarche d'éco-conception</div>
                <div class="card" data-card="pharmacovigilance">Assurer la pharmacovigilance</div>
                <div class="card" data-card="detruire">Détruire lui-même les MNU</div>
            </div>
            <button class="btn btn-primary" id="validate-stage2">Valider les responsabilités</button>
            <div class="feedback" id="stage2-feedback"></div>
            <div class="info-box regulatory-info">
                 <h3><i class="fas fa-book"></i> Textes applicables</h3>
                 <p><strong>Article R. 4211-23 IV 1° du Code de la santé publique :</strong></p>
                 <p class="leg-text">"1° “ Producteur ” au sens du I de l'article L. 541-10 du code de l'environnement, les exploitants mentionnés au 3° de l'article R. 5124-2 du code de la santé publique ;"</p>
                  <p><strong>Article R. 5124-2 3° du Code de la santé publique (Extrait) :</strong></p>
                 <p class="leg-text">"3° Exploitant, l'entreprise ou l'organisme se livrant à l'exploitation de médicaments [...]"</p>
                 <p><strong>Article L. 541-10 I du Code de l'environnement :</strong></p>
                 <p class="leg-text">"[...] il peut être fait obligation à toute personne physique ou morale qui élabore, fabrique, manipule, traite, vend ou importe des produits générateurs de déchets [...] de pourvoir ou de contribuer à la prévention et à la gestion des déchets qui en proviennent ainsi que d'adopter une démarche d'écoconception des produits [...] Pour s'acquitter de cette obligation, les producteurs mettent en place collectivement des éco-organismes [...] auxquels ils transfèrent leur obligation et versent en contrepartie une contribution financière. [...]"</p>
            </div>
            <div class="next-stage-container" id="next-stage-container-2" style="display: none; margin-top: 15px;">
                <button class="btn btn-success next-stage-btn" id="next-stage-2" disabled>
                    Passer à l'étape suivante
                </button>
            </div>
        </div>

        <!-- Stage 3: La Logistique Séquentielle -->
        <div class="stage" id="stage3">
             <div class="stage-header">
                <div class="stage-title">
                    <div class="stage-number">3</div>
                    <!-- Titre modifié -->
                    <h2>La Logistique Séquentielle</h2>
                </div>
                <div class="stage-time">~2 minutes</div>
            </div>
            <!-- Instructions modifiées -->
            <p>Reconstituez le parcours chronologique des MNU depuis leur collecte jusqu'à leur élimination finale.</p>
            <p><strong>Cliquez sur les étapes/actions ci-dessous DANS L'ORDRE CORRECT pour les ajouter à la séquence.</strong> Cliquez sur une étape dans votre séquence pour la retirer.</p>

            <!-- Suppression du map-container -->

            <h3>Étapes / Actions Disponibles :</h3>
            <!-- Container des étapes disponibles, maintenant avec un ID différent pour éviter confusion -->
            <div class="card-container" id="available-logistics-steps">
                 <!-- Les cartes restent similaires, mais leur comportement changera via JS -->
                 <!-- Assurez-vous que data-step-id est unique et correspond à la logique -->
                 <div class="card" data-step-id="pharmacie">Collecte gratuite à l'officine</div>
                 <div class="card" data-step-id="receptacle">Stockage dans réceptacle sécurisé</div>
                 <div class="card" data-step-id="enlevement">Enlèvement depuis l'officine par prestataire</div>
                 <div class="card" data-step-id="regroupement">Regroupement / Tri sur plateforme logistique</div>
                 <div class="card" data-step-id="transport">Transport vers l'unité de traitement</div>
                 <!-- L'incinération est maintenant une étape comme les autres -->
                 <div class="card" data-step-id="incineration">Destruction finale par incinération</div>
                 <!-- On peut ajouter quelques leurres si désiré -->
                 <div class="card" data-step-id="recyclage">Recyclage chimique</div>
                 <div class="card" data-step-id="humanitaire">Redistribution humanitaire</div>
            </div>

            <!-- Nouvelle section pour afficher la séquence construite par l'utilisateur -->
            <div class="ordered-sequence-area">
                <h3>Votre Séquence Construite :</h3>
                <ol id="built-sequence-list"></ol>
                <!-- Ajout d'un bouton pour vider la séquence si besoin -->
                <button class="btn btn-secondary btn-sm" id="clear-sequence-btn">Recommencer la séquence</button> <!-- Changed btn-help to btn-secondary -->
            </div>

            <!-- Suppression de la section "Destination finale imposée?" -->

            <!-- Bouton de validation et feedback restent -->
            <button class="btn btn-primary" id="validate-stage3" style="margin-top: 20px;" disabled>Valider la Séquence</button>
            <div class="feedback" id="stage3-feedback"></div>

            <!-- L'info réglementaire peut rester -->
            <div class="info-box regulatory-info">
                 <h3><i class="fas fa-book"></i> Textes applicables</h3>
                 <p><strong>Article R. 4211-24 du Code de la santé publique :</strong></p>
                 <p class="leg-text">"Les producteurs [...] réalisent les opérations suivantes :
1° La remise, à titre gratuit, de réceptacles aux officines de pharmacie ;
2° L'enlèvement, le regroupement, le tri et le transport des médicaments non utilisés [...] depuis les officines de pharmacie jusqu'à leur lieu de destination ;
3° La destruction des médicaments non utilisés."</p>
                 <p><strong>Article R. 4211-27 du Code de la santé publique :</strong></p>
                 <p class="leg-text">"Les médicaments non utilisés sont détruits par incinération avec valorisation énergétique dans le respect de la réglementation en vigueur."</p>
                 <p><strong>Note :</strong> Redistribution/réutilisation interdite.</p>
            </div>
            <div class="next-stage-container" id="next-stage-container-3" style="display: none; margin-top: 15px;">
                <button class="btn btn-success next-stage-btn" id="next-stage-3" disabled>
                    Passer à l'étape suivante
                </button>
            </div>
        </div>

         <!-- Stage 4: Le Cahier des Charges Oublié -->
        <div class="stage" id="stage4">
             <div class="stage-header">
                <div class="stage-title">
                    <div class="stage-number">4</div>
                    <h2>Le Cahier des charges oublié</h2>
                </div>
                <div class="stage-time">~1 minute</div>
            </div>
            <p>Retrouvez les infos clés sur l'éco-organisme MNU : objectif, statut, nom.</p>
            <p><strong>Sélectionnez les bonnes réponses et tapez le nom.</strong></p>
            <h3>Objectif MINIMAL de collecte (%) fixé ?</h3>
            <div class="card-container" id="collection-target">
                <div class="card" data-target="50">50%</div>
                <div class="card" data-target="60">60%</div>
                <div class="card" data-target="70">70%</div>
                <div class="card" data-target="80">80%</div>
            </div>
            <h3>Statut juridique obligatoire (L.541-10 C. Env) ?</h3>
            <div class="card-container" id="eco-org-nature">
                <div class="card" data-nature="lucratif">Société commerciale</div>
                <div class="card" data-nature="non-lucratif">Organisme à but non lucratif</div>
                <div class="card" data-nature="publique">Service public</div>
                <div class="card" data-nature="association">Association 1901</div>
            </div>
            <h3>Nom de l'éco-organisme agréé MNU ?</h3>
            <div class="input-group">
                <input type="text" id="eco-org-name" placeholder="Entrez le nom">
            </div>
            <button class="btn btn-primary" id="validate-stage4">Valider les informations clés</button>
            <div class="feedback" id="stage4-feedback"></div>
            <div class="info-box regulatory-info">
                 <h3><i class="fas fa-book"></i> Textes Réglementaires & Arrêtés Applicables</h3>
                 <p><strong>Extrait Cahier des Charges (Arrêté 29 oct. 2021) :</strong></p>
                 <p class="leg-text">"2.1. Objectifs de collecte [...] Objectif du pourcentage minimal des MNU collectés : 70%"</p>
                 <p><strong>Article L. 541-10 I C. Env (Extrait Statut) :</strong></p>
                 <p class="leg-text">"[...] les éco-organismes [...] sont à but non lucratif."</p>
                 <p><strong>Extrait Arrêté d'agrément (22 déc. 2021) :</strong></p>
                 <p class="leg-text">"Est agréé, [...] l'organisme Cyclamed [...] en tant qu'éco-organisme [...]"</p>
            </div>
            <div class="next-stage-container" id="next-stage-container-4" style="display: none; margin-top: 15px;">
                <button class="btn btn-success next-stage-btn" id="next-stage-4" disabled>
                    Passer à l'étape suivante
                </button>
            </div>
        </div>


        <!-- Final Stage: Validation du Système -->
        <div class="stage" id="final-stage">
             <div class="stage-header">
                <div class="stage-title">
                    <div class="stage-number">5</div>
                    <h2>Restauration du Système</h2>
                </div>
                <div class="stage-time">~1 minute</div>
            </div>
            <p>Mission presque accomplie ! Entrez le code numérique et le mot de passe final pour verrouiller la conformité de la filière MNU.</p>
            <!-- MODIFIED INFO BOX CONTENT BELOW -->
            <div class="info-box">
                <h3><i class="fas fa-key"></i> Combinez vos découvertes pour les Codes d'Accès</h3>
                <p><strong>Code Numérique (5 chiffres) :</strong> Constituez ce code en concaténant dans l'ordre :</p>
                <ul>
                    <li>Le <strong>nombre</strong> d'items correctement classés comme MNU à l'étape 1.</li>
                    <li>L'<strong>objectif</strong> de collecte (en pourcentage) identifié à l'étape 4.</li>
                    <li>Le <strong>numéro</strong> (deux chiffres) de l'article fondateur de la REP dans le Code de l'Environnement (L.541-XX), évoqué lors des étapes précédentes.</li>
                </ul>
                <p style="text-align: center; font-style: italic; font-size: 0.9rem;">Exemple fictif : Si Nombre = 3, Objectif = 80, Numéro = 12 => Code = 38012</p>
                <!-- REMOVED final calculated code display -->

                <hr style="margin: 15px 0;">

                <p><strong>Mot de Passe (Alphanumérique) :</strong> Constituez ce mot de passe en concaténant dans l'ordre :</p>
                 <ul>
                     <li>La <strong>première lettre</strong> de l'obligation financière principale du producteur trouvée à l'étape 2.</li>
                     <li>Le <strong>nom</strong> complet (en majuscules) de l'éco-organisme agréé identifié à l'étape 4.</li>
                 </ul>
                 <p style="text-align: center; font-style: italic; font-size: 0.9rem;">Exemple fictif : Si Lettre = X, Nom = ORGA => Mot de passe = XORGA</p>
                 <!-- REMOVED final calculated password display -->
            </div>
            <!-- END OF MODIFIED INFO BOX CONTENT -->
            <div class="input-group">
                <label for="final-code">Code numérique de restauration :</label>
                <input type="text" id="final-code" placeholder="Entrez le code à 5 chiffres">
            </div>
            <div class="input-group">
                <label for="final-password">Mot de passe de conformité :</label>
                <input type="text" id="final-password" placeholder="Entrez le mot de passe">
            </div>
            <div class="feedback" id="final-feedback"></div>
            <button class="btn btn-primary" id="validate-final">Valider et sécuriser la filière</button>
        </div>

        <!-- Success Screen -->
        <div class="stage" id="success">
            <div class="certificate" id="certificate-content">
                <h2><i class="fas fa-shield-alt"></i> CERTIFICAT DE CONFORMITÉ MNU</h2>
                <p>Félicitations à l'équipe <strong id="team-name-display-cert" style="color: var(--primary);"></strong> !</p>
                <div id="participants-section-cert" style="margin-top: 15px; text-align: left;">
                    <h4>Participants :</h4>
                    <ul id="participant-list-cert" style="list-style: none; padding-left: 10px; font-size: 0.9rem;"></ul>
                </div>
                <p style="margin-top: 20px;"><strong>Mission accomplie en <span id="time-taken"></span> !</strong> La filière MNU est sécurisée !</p>
                <p>Temps restant : <strong id="time-remaining" style="color: var(--success);"></strong></p>
                <h3 style="margin-top: 25px;">Synthèse Réglementaire :</h3>
                 <ul>
                    <li><strong>Périmètre MNU :</strong> Médicaments usage humain particuliers (L.5111-1, R.4211-23 CSP).</li>
                    <li><strong>Responsabilité :</strong> Producteur = Exploitant (R.4211-23, R.5124-2 CSP ; L.541-10 C. Env).</li>
                    <li><strong>Collecte :</strong> Gratuite en pharmacie (R.4211-24 CSP).</li>
                    <li><strong>Traitement :</strong> Incinération obligatoire (R.4211-27 CSP).</li>
                    <li><strong>Objectif :</strong> Collecte min. 70% (Cahier Charges 2021).</li>
                    <li><strong>Acteur :</strong> CYCLAMED (éco-org agréé non lucratif).</li>
                </ul>
                <div class="certificate-seal">CONFORME</div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" id="download-pdf-certificate">
                    <i class="fas fa-file-pdf"></i> Télécharger le Certificat (PDF)
                </button>
                <button class="btn btn-success" id="restart-game">Nouvelle mission d'audit</button>
            </div>
        </div>


        <!-- Failure Screen -->
        <div class="stage" id="failure">
            <div style="text-align:center;">
                 <h2 style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> Mission échouée</h2>
                 <p style="font-size: 3rem; margin: 15px 0;">⏳</p>
                 <p><strong>Temps écoulé !</strong> La non-conformité persiste.</p>
                 <p>Revoyez les textes réglementaires et réessayez !</p>
                 <button class="btn btn-danger" id="restart-game-failure" style="margin-top: 20px;">Relancer la Mission</button>
            </div>
        </div>

        <!-- REMOVED Help Modal -->

    </div> <!-- End Container -->

    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" integrity="sha512-Tn2m0TIpgVyTzzvmxLNuqbSJH3JP8jm+Cy3hvHrW7ndTDcJ1w5mBiksqDBb8GpE2ksktFvDB/ykZ0mDpsZj20w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- jsPDF and html2canvas Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    <script>
        // --- Constants ---
        // !!! URL DE VOTRE SCRIPT GOOGLE APPS DÉPLOYÉ !!!
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbykqjnxlvNMJGyvG8DpSM4Ea4K0dr3ZO6hs-W-8BWQ7Jj2BO5wz3Jr_zVaknTK66lmx/exec';
        const stageOrder = ['intro', 'stage1', 'stage2', 'stage3', 'stage4', 'final-stage', 'success', 'failure']; // Order for navigation
        const correctLogisticsSequence = [
            'pharmacie', 'receptacle', 'enlevement', 'regroupement', 'transport', 'incineration'
        ];

        // --- Game State ---
        const gameState = {
            teamName: '',
            teamId: null, // Ajouté pour l'identifiant unique pour le suivi
            participants: [],
            startTime: null,
            totalGameTime: 10 * 60 * 1000,
            timeRemaining: 10 * 60 * 1000,
            timerInterval: null,
            currentStage: 'intro',
            stageResults: {
                stage1: { completed: false, correctItemsCount: 0 },
                stage2: { completed: false, producerCorrect: false, obligationsCorrect: false, keyLetter: '' },
                stage3: { completed: false, builtSequence: [], sequenceCorrect: false },
                stage4: { completed: false, collectionTarget: '', ecoOrgNatureCorrect: false, ecoOrgNameCorrect: false, ecoOrgName: '' }
            },
            finalCode: '',
            finalPassword: '',
        };

        // Variable globale pour l'intervalle de mise à jour périodique
        let periodicUpdateInterval = null;

        // --- DOM Elements ---
        const timerElement = document.getElementById('timer');
        const progressElement = document.getElementById('progress');
        const teamNameInput = document.getElementById('team-name');
        const participantNamesInput = document.getElementById('participant-names');
        const teamNameDisplay = document.getElementById('team-name-display');
        const teamNameDisplayCert = document.getElementById('team-name-display-cert');
        const participantListCert = document.getElementById('participant-list-cert');
        const startGameButton = document.getElementById('start-game');
        const stages = document.querySelectorAll('.stage');
        const stageDots = document.querySelectorAll('.stage-dot');
        const itemsContainer = document.getElementById('items-to-sort');
        const cyclamedZone = document.getElementById('cyclamed-zone').querySelector('.dropped-items');
        const excludedZone = document.getElementById('excluded-zone').querySelector('.dropped-items');
        const validateStage1Button = document.getElementById('validate-stage1');
        const validateStage2Button = document.getElementById('validate-stage2');
        const validateStage3Button = document.getElementById('validate-stage3');
        const validateStage4Button = document.getElementById('validate-stage4');
        const validateFinalButton = document.getElementById('validate-final');
        const nextStageContainer1 = document.getElementById('next-stage-container-1');
        const nextStageBtn1 = document.getElementById('next-stage-1');
        const nextStageContainer2 = document.getElementById('next-stage-container-2');
        const nextStageBtn2 = document.getElementById('next-stage-2');
        const nextStageContainer3 = document.getElementById('next-stage-container-3');
        const nextStageBtn3 = document.getElementById('next-stage-3');
        const nextStageContainer4 = document.getElementById('next-stage-container-4');
        const nextStageBtn4 = document.getElementById('next-stage-4');
        const stage1Feedback = document.getElementById('stage1-feedback');
        const stage2Feedback = document.getElementById('stage2-feedback');
        const stage3Feedback = document.getElementById('stage3-feedback');
        const stage4Feedback = document.getElementById('stage4-feedback');
        const finalFeedback = document.getElementById('final-feedback');
        const producerCardsContainer = document.getElementById('producer-cards');
        const obligationCardsContainer = document.getElementById('obligation-cards');
        const availableLogisticsStepsContainer = document.getElementById('available-logistics-steps');
        const builtSequenceList = document.getElementById('built-sequence-list');
        const clearSequenceButton = document.getElementById('clear-sequence-btn');
        const collectionTargetContainer = document.getElementById('collection-target');
        const ecoOrgNatureContainer = document.getElementById('eco-org-nature');
        const ecoOrgNameInput = document.getElementById('eco-org-name');
        const finalCodeInput = document.getElementById('final-code');
        const finalPasswordInput = document.getElementById('final-password');
        const timeRemainingDisplay = document.getElementById('time-remaining');
        const timeTakenDisplay = document.getElementById('time-taken');
        const restartGameButton = document.getElementById('restart-game');
        const restartGameFailureButton = document.getElementById('restart-game-failure');
        const backdoorButton = document.getElementById('backdoor-btn');
        const downloadPdfButton = document.getElementById('download-pdf-certificate');
        const prevStageButton = document.getElementById('prev-stage-btn');
        const introTitleElement = document.getElementById('intro-title');
        const teamNameGroup = document.getElementById('team-name-group');
        const participantsGroup = document.getElementById('participants-group');
        const certificateContentElement = document.getElementById('certificate-content');


        // --- Google Sheet Update Logic ---

        /**
         * Envoie les données de mise à jour à l'URL Google Apps Script.
         * Utilise navigator.sendBeacon si possible pour la fiabilité en quittant la page,
         * sinon utilise fetch avec keepalive.
         * @param {object} eventData - Données spécifiques à l'événement à envoyer.
         */
        function sendUpdateToSheet(eventData = {}) {
            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'VOTRE_URL_APPS_SCRIPT_ICI') {
                console.warn("APPS_SCRIPT_URL non configurée ou placeholder non remplacé. Mise à jour non envoyée.");
                return;
            }
            if (!gameState.teamId) {
                // Attendre que teamId soit défini (peut arriver si sendUpdate est appelé trop tôt)
                console.warn("Tentative d'envoi sans Team ID. Reporté.");
                 // Optionnel: essayer à nouveau après un court délai
                 // setTimeout(() => sendUpdateToSheet(eventData), 500);
                return;
            }

            const payload = {
                // Données statiques de la session
                teamId: gameState.teamId,
                teamName: gameState.teamName,
                // Données dynamiques
                currentStage: gameState.currentStage,
                timeRemainingSec: Math.floor(gameState.timeRemaining / 1000),
                status: (gameState.currentStage === 'success' || gameState.currentStage === 'failure') ? (gameState.currentStage === 'success' ? 'Terminé' : 'Échoué') : 'En cours',
                // Ajouter l'état d'avancement des étapes
                stage1_completed: !!gameState.stageResults.stage1.completed, // Assure un booléen
                stage2_completed: !!gameState.stageResults.stage2.completed,
                stage3_completed: !!gameState.stageResults.stage3.completed,
                stage4_completed: !!gameState.stageResults.stage4.completed,
                 // Données spécifiques à l'événement (fusionnées)
                ...eventData
            };

            // Utilise navigator.sendBeacon si disponible
            const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });

            if (navigator.sendBeacon) {
               if (!navigator.sendBeacon(APPS_SCRIPT_URL, blob)) {
                   console.error('sendBeacon failed for Apps Script update. Falling back to fetch.');
                   // Fallback vers fetch si sendBeacon échoue immédiatement (rare)
                   sendWithFetch(payload);
               } else {
                   // console.log('Update sent via sendBeacon:', payload); // Optionnel : Log pour débogage
               }
            } else {
                sendWithFetch(payload);
            }
        }

        // Fonction helper pour envoyer avec fetch (fallback)
        function sendWithFetch(payload) {
             fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Important pour éviter les erreurs CORS simples avec Apps Script
                cache: 'no-cache',
                headers: {
                  // Content-Type n'est pas strictement nécessaire avec no-cors, mais bonne pratique
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload),
                keepalive: true // Important pour les mises à jour avant de quitter la page
            })
            .then(() => {
                // console.log('Update signal sent via fetch (no-cors). Response not readable.'); // Optionnel
            })
            .catch(error => {
                console.error('Error sending update via fetch:', error);
            });
        }


        // --- Core Game Logic ---

        function initGame() {
            // Event listeners
            startGameButton.addEventListener('click', startGame);
            validateStage1Button.addEventListener('click', validateStage1);
            validateStage2Button.addEventListener('click', validateStage2);
            validateStage3Button.addEventListener('click', validateStage3);
            validateStage4Button.addEventListener('click', validateStage4);
            validateFinalButton.addEventListener('click', validateFinal);
            nextStageBtn1.addEventListener('click', () => showStage('stage2'));
            nextStageBtn2.addEventListener('click', () => showStage('stage3'));
            nextStageBtn3.addEventListener('click', () => showStage('stage4'));
            nextStageBtn4.addEventListener('click', () => showStage('final-stage'));
            restartGameButton.addEventListener('click', resetGame);
            restartGameFailureButton.addEventListener('click', resetGame);
            backdoorButton.addEventListener('click', handleBackdoor);
            downloadPdfButton.addEventListener('click', handleDownloadCertificatePDF);
            clearSequenceButton.addEventListener('click', clearBuiltSequence);
            prevStageButton.addEventListener('click', goToPreviousStage);

            initStage1Interactions();
            initCardSelection();
            initStage3CardClicks();
            shuffleAvailableLogisticsSteps();

            resetGame(); // Initialise l'état du jeu et l'interface
        }

        function startGame() {
            if (!teamNameInput.value.trim()) {
                alert('Veuillez entrer un nom d\'équipe.');
                teamNameInput.focus();
                return;
            }
            if (introTitleElement) introTitleElement.style.display = 'none';

            // Générer un Team ID unique pour cette session
            gameState.teamId = 'team-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
            console.log("Generated Team ID:", gameState.teamId); // Pour le débogage

            gameState.teamName = teamNameInput.value.trim();
            teamNameDisplay.textContent = `Équipe: ${gameState.teamName}`;
            const namesString = participantNamesInput.value.trim();
            gameState.participants = namesString ? namesString.split('\n').map(name => name.trim()).filter(name => name !== '') : [];
            console.log("Participants:", gameState.participants);
            if (teamNameGroup) teamNameGroup.style.display = 'none';
            if (participantsGroup) participantsGroup.style.display = 'none';
            if (startGameButton) startGameButton.style.display = 'none';
            gameState.startTime = Date.now();
            gameState.timeRemaining = gameState.totalGameTime;
            startTimer(); // Démarre le timer principal ET le timer périodique d'update
            showStage('stage1'); // Passe directement à l'étape 1

            // Envoyer la mise à jour initiale à Google Sheet
            // Utiliser setTimeout pour s'assurer que teamId est bien défini avant l'envoi initial
            setTimeout(() => sendUpdateToSheet({ currentStage: 'stage1' }), 100);
        }

        function startTimer() {
            clearInterval(gameState.timerInterval);
            clearInterval(periodicUpdateInterval); // Arrêter l'intervalle périodique précédent s'il existe

            updateTimerDisplay(); // Premier affichage
            gameState.timerInterval = setInterval(() => {
                const elapsed = Date.now() - gameState.startTime;
                gameState.timeRemaining = Math.max(gameState.totalGameTime - elapsed, 0);
                updateTimerDisplay(); // Met à jour l'affichage local

                if (gameState.timeRemaining <= 0) {
                    clearInterval(gameState.timerInterval);
                    clearInterval(periodicUpdateInterval); // Arrêter aussi la mise à jour périodique
                    if (gameState.currentStage !== 'success') { // Ne pas aller à failure si déjà success
                       showStage('failure'); // showStage gérera l'envoi de l'update 'failure'
                    }
                }
            }, 1000); // Timer principal chaque seconde

            // Démarrer l'intervalle de mise à jour périodique (ex: toutes les 20 sec)
            periodicUpdateInterval = setInterval(() => {
                // N'envoyer que si le jeu est en cours (pas sur intro, success ou failure)
                if (!['intro', 'success', 'failure'].includes(gameState.currentStage)) {
                    sendUpdateToSheet(); // Envoie l'état actuel (stage, temps restant, status 'En cours')
                    // console.log('Periodic update sent.'); // Optionnel : Log pour débogage
                }
            }, 20000); // Envoyer toutes les 20 secondes
        }


        function updateTimerDisplay() {
            const totalSeconds = Math.floor(gameState.timeRemaining / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerElement.classList.remove('warning', 'danger');
            if (minutes < 1 && totalSeconds > 0) timerElement.classList.add('danger'); // Danger si moins d'1 min mais > 0s
            else if (minutes < 3) timerElement.classList.add('warning');
        }

        function resetTimerDisplay() {
            const minutes = Math.floor(gameState.totalGameTime / (60 * 1000));
            const seconds = Math.floor((gameState.totalGameTime % (60 * 1000)) / 1000);
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerElement.classList.remove('warning', 'danger');
        }

        function showStage(stageId) {
             stages.forEach(stage => stage.classList.remove('active'));
             const nextStage = document.getElementById(stageId);

             if (nextStage) {
                 nextStage.classList.add('active');
                 const previousStage = gameState.currentStage; // Stocker l'étape précédente
                 gameState.currentStage = stageId;

                 // Envoyer une mise à jour lors du passage à l'état d'échec
                 if (stageId === 'failure' && previousStage !== 'failure') {
                      clearInterval(gameState.timerInterval); // S'assurer que le timer est arrêté
                      clearInterval(periodicUpdateInterval); // Arrêter aussi la mise à jour périodique
                      gameState.timeRemaining = 0; // Forcer le temps à 0
                      updateTimerDisplay(); // Mettre à jour l'affichage local
                      // Utiliser setTimeout pour laisser le temps à gameState.currentStage de se mettre à jour
                      setTimeout(() => sendUpdateToSheet({ status: 'Échoué', timeRemainingSec: 0 }), 100);
                      console.log("Game ended in failure state.");
                 }
                 // Optionnel: Envoyer une update à chaque changement de stage visible (peut être bruyant)
                 // else if (stageId !== previousStage && !['success', 'failure', 'intro'].includes(stageId)) {
                 //     sendUpdateToSheet();
                 // }


                 // Gérer le bouton "Précédent"
                 prevStageButton.style.display = 'none';
                 prevStageButton.disabled = true;
                 const currentStageIndex = stageOrder.indexOf(stageId);
                 if (currentStageIndex > 1 && currentStageIndex <= stageOrder.indexOf('final-stage')) {
                    let previousCompletedStageExists = false;
                    for (let i = currentStageIndex - 1; i >= 1; i--) {
                        const prevStageId = stageOrder[i];
                        if (gameState.stageResults[prevStageId] && gameState.stageResults[prevStageId].completed) {
                            previousCompletedStageExists = true;
                            break;
                        }
                    }
                    if (previousCompletedStageExists) {
                        prevStageButton.style.display = 'inline-block';
                        prevStageButton.disabled = false;
                    }
                 }

                 updateProgress();
                 updateStageDots();
                 window.scrollTo(0, 0);
             } else {
                 console.error("Stage not found:", stageId);
             }
        }

        function goToPreviousStage() {
            const currentStageIndex = stageOrder.indexOf(gameState.currentStage);
            if (currentStageIndex <= 1) return;

            for (let i = currentStageIndex - 1; i >= 1; i--) {
                const prevStageId = stageOrder[i];
                 if (gameState.stageResults[prevStageId] && gameState.stageResults[prevStageId].completed) {
                    console.log(`Going back from ${gameState.currentStage} to ${prevStageId}`);
                    showStage(prevStageId);
                    return;
                }
            }
             console.warn("Could not find a previously completed stage to go back to.");
        }

        function updateProgress() {
             const progressStageOrder = ['intro', 'stage1', 'stage2', 'stage3', 'stage4', 'final-stage', 'success', 'failure'];
             let currentProgressIndex = progressStageOrder.indexOf(gameState.currentStage);
             const progressPercentage = (currentProgressIndex / (progressStageOrder.length - 3)) * 100;
             progressElement.style.width = `${Math.min(100, Math.max(0, progressPercentage))}%`;
        }

        function updateStageDots() {
            const mainStages = ['stage1', 'stage2', 'stage3', 'stage4', 'final-stage'];
            let stageIndex = mainStages.indexOf(gameState.currentStage);
            if (gameState.currentStage === 'intro') stageIndex = -1;
            if (gameState.currentStage === 'success' || gameState.currentStage === 'failure') stageIndex = mainStages.length;

            stageDots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                const dotStageId = mainStages[index];
                if (index < stageIndex) {
                    dot.classList.add('completed');
                } else if (index === stageIndex) {
                    dot.classList.add('active');
                }
                if(gameState.stageResults[dotStageId] && gameState.stageResults[dotStageId].completed) {
                    dot.classList.remove('active');
                    dot.classList.add('completed');
                }
            });
        }

        function handleBackdoor() {
            const code = prompt("Code d'accès spécial ?");
            if (code === "SKIP") {
                skipStage(gameState.currentStage);
            } else if (code !== null) {
                alert("Code incorrect.");
            }
        }

        function updateFinalStageInfoDisplay() {
            // Ne fait plus rien car les codes calculés ne sont plus affichés ici
            // console.log("Final stage info display update called (no UI change).");
        }

        function skipStage(currentStageId) {
             console.clear();
             console.log(`--- PORTE DÉROBÉE ACTIVÉE (Saut de l'Étape ${currentStageId}) ---`);
             let nextStageId = '';
             let infoBoxToShow = null;
             let updateData = {}; // Données à envoyer à la feuille

              if (currentStageId === 'intro') {
                  if (teamNameGroup) teamNameGroup.style.display = 'none';
                  if (participantsGroup) participantsGroup.style.display = 'none';
                  if (startGameButton) startGameButton.style.display = 'none';
                  if (introTitleElement) introTitleElement.style.display = 'none';
                  if (!gameState.teamName) {
                     gameState.teamName = "Équipe Spéciale";
                     teamNameDisplay.textContent = `Équipe: ${gameState.teamName}`;
                     console.log("  - (Using default team name)");
                  }
                   // Générer ID si inexistant (cas où on skip avant même startGame)
                   if (!gameState.teamId) {
                      gameState.teamId = 'team-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
                      console.log("  - Generated Team ID (via skip):", gameState.teamId);
                   }
                  if (!gameState.startTime) {
                      gameState.startTime = Date.now();
                      startTimer(); // Démarre timer principal ET périodique
                      console.log("  - (Starting timer)");
                  }
                  nextStageId = 'stage1';
                  updateData = { currentStage: nextStageId }; // Envoyer le début à l'étape 1
              } else {
                  const stageIndex = stageOrder.indexOf(currentStageId);
                  if (stageIndex >= 1 && stageIndex <= 4) {
                       if(gameState.stageResults[currentStageId]) {
                           gameState.stageResults[currentStageId].completed = true;
                            updateData[`stage${stageIndex}_completed`] = true; // Marquer comme complété pour l'update sheet

                            switch(currentStageId) {
                                case 'stage1': gameState.stageResults.stage1.correctItemsCount = 2; break;
                                case 'stage2':
                                    gameState.stageResults.stage2.producerCorrect = true;
                                    gameState.stageResults.stage2.obligationsCorrect = true;
                                    gameState.stageResults.stage2.keyLetter = 'F';
                                    break;
                                case 'stage3':
                                     gameState.stageResults.stage3.builtSequence = [...correctLogisticsSequence];
                                     gameState.stageResults.stage3.sequenceCorrect = true;
                                    break;
                                case 'stage4':
                                    gameState.stageResults.stage4.collectionTarget = '70';
                                    gameState.stageResults.stage4.ecoOrgNatureCorrect = true;
                                    gameState.stageResults.stage4.ecoOrgNameCorrect = true;
                                    gameState.stageResults.stage4.ecoOrgName = 'CYCLAMED';
                                    break;
                            }
                            console.log(`  - Stage ${currentStageId} marked as completed with correct answers set.`);
                            infoBoxToShow = document.querySelector(`#${currentStageId} .regulatory-info`);
                            if(infoBoxToShow) infoBoxToShow.classList.add('visible');
                       }
                  }

                 // Déterminer l'étape suivante
                 switch (currentStageId) {
                     case 'stage1': nextStageId = 'stage2'; break;
                     case 'stage2': nextStageId = 'stage3'; break;
                     case 'stage3': nextStageId = 'stage4'; break;
                     case 'stage4':
                         // Assurer que les données prérequises sont là
                         if (!gameState.stageResults.stage1.correctItemsCount) gameState.stageResults.stage1.correctItemsCount = 2;
                         if (!gameState.stageResults.stage2.keyLetter) gameState.stageResults.stage2.keyLetter = 'F';
                         if (!gameState.stageResults.stage4.ecoOrgName) gameState.stageResults.stage4.ecoOrgName = 'CYCLAMED';
                         if (!gameState.stageResults.stage4.collectionTarget) gameState.stageResults.stage4.collectionTarget = '70';

                         gameState.finalCode = `${gameState.stageResults.stage1.correctItemsCount}${gameState.stageResults.stage4.collectionTarget}10`;
                         gameState.finalPassword = `${gameState.stageResults.stage2.keyLetter}${gameState.stageResults.stage4.ecoOrgName}`;
                         console.log("------------------------------------");
                         console.log("Code Final Calculé (après skip):", gameState.finalCode);
                         console.log("Mot de Passe Final Calculé (après skip):", gameState.finalPassword);
                         console.log("------------------------------------");
                         updateFinalStageInfoDisplay();
                         nextStageId = 'final-stage';
                         break;
                     default:
                         console.log("Impossible de sauter depuis l'étape actuelle:", currentStageId);
                         alert("Impossible de sauter cette étape.");
                         return;
                 }
                 // Ajouter l'étape suivante à l'update sheet
                  updateData.currentStage = nextStageId;
              }

             // Envoyer la mise à jour à la feuille pour refléter le saut
             // Utiliser setTimeout pour s'assurer que teamId est défini si on skip depuis l'intro
             setTimeout(() => sendUpdateToSheet(updateData), 100);


             console.log("-------------------------------------------------------------");
             if(nextStageId) showStage(nextStageId);
        }


        // --- Stage Specific Interactions & Validations ---

        // == Stage 1: Tri ==
        function initStage1Interactions() {
            itemsContainer.querySelectorAll('.item').forEach(item => item.addEventListener('click', () => item.classList.toggle('selected')));
            document.getElementById('cyclamed-zone').addEventListener('click', (e) => { if(e.target.classList.contains('dropped-item')) e.target.remove(); else if (e.target.closest('.drop-zone')) moveSelectedItemsToZone(cyclamedZone, excludedZone); });
            document.getElementById('excluded-zone').addEventListener('click', (e) => { if(e.target.classList.contains('dropped-item')) e.target.remove(); else if (e.target.closest('.drop-zone')) moveSelectedItemsToZone(excludedZone, cyclamedZone); });
        }
        function moveSelectedItemsToZone(targetZone, otherZone) {
             itemsContainer.querySelectorAll('.item.selected').forEach(item => { const itemId=item.dataset.item, itemText=item.querySelector('p').textContent; const existingOther = otherZone.querySelector(`.dropped-item[data-item="${itemId}"]`); if(existingOther) existingOther.remove(); if (!targetZone.querySelector(`.dropped-item[data-item="${itemId}"]`)) { const dropped = document.createElement('div'); dropped.className='dropped-item'; dropped.dataset.item=itemId; dropped.textContent=itemText; dropped.addEventListener('click', ()=>dropped.remove()); targetZone.appendChild(dropped); } item.classList.remove('selected'); });
        }
        function validateStage1() {
            if(gameState.stageResults.stage1.completed) return;
            const droppedC = Array.from(cyclamedZone.querySelectorAll('.dropped-item')).map(el => el.dataset.item); const droppedE = Array.from(excludedZone.querySelectorAll('.dropped-item')).map(el => el.dataset.item); const allCount = droppedC.length + droppedE.length; const totalOrig = itemsContainer.querySelectorAll('.item').length; const correctC = ['medicament-plein', 'medicament-entame']; const allOrigData = Array.from(itemsContainer.querySelectorAll('.item')).map(el => el.dataset.item); const correctE = allOrigData.filter(i => !correctC.includes(i)); let errors = [];
            if (allCount < totalOrig) errors.push(`Tri incomplet (${totalOrig - allCount} restants).`); let correctCFound = 0; droppedC.forEach(i => { if (correctC.includes(i)) correctCFound++; else errors.push(`"${itemsContainer.querySelector(`.item[data-item='${i}'] p`).textContent}" incorrect dans ✅ MNU.`); }); if (correctCFound !== correctC.length && allCount === totalOrig) errors.push(`Manque ${correctC.length - correctCFound} item(s) dans ✅ MNU.`); let correctEFound = 0; droppedE.forEach(i => { if (correctE.includes(i)) correctEFound++; else errors.push(`"${itemsContainer.querySelector(`.item[data-item='${i}'] p`).textContent}" incorrect dans ❌ Exclus.`); }); if (correctEFound !== correctE.length && allCount === totalOrig) errors.push(`Manque ${correctE.length - correctEFound} item(s) dans ❌ Exclus.`);

            if (errors.length === 0) {
                gameState.stageResults.stage1.correctItemsCount = correctC.length;
                stage1Feedback.textContent = `Bravo ! Tri parfait. Le nombre d'items correctement triés comme MNU est ${correctC.length}.`;
                stage1Feedback.className = 'feedback success';
                stage1Feedback.style.display = 'block';
                gameState.stageResults.stage1.completed = true;
                document.querySelector('#stage1 .regulatory-info')?.classList.add('visible');
                validateStage1Button.style.display = 'none';
                nextStageContainer1.style.display = 'block';
                // *** ENVOYER UPDATE SHEET ***
                sendUpdateToSheet({ stage1_completed: true });
                nextStageBtn1.disabled = false;
            } else {
                stage1Feedback.textContent = `Erreurs : ${errors.join(' ')}`;
                stage1Feedback.className = 'feedback error';
                stage1Feedback.style.display = 'block';
            }
        }

        // == Stage 2 & 4: Card Selection Logic ==
        function initCardSelection() {
            document.querySelectorAll('.card-container').forEach(cont => {
                if (cont.id === 'available-logistics-steps') return;
                const multi = cont.id === 'obligation-cards';
                cont.querySelectorAll('.card').forEach(card => card.addEventListener('click', () => {
                     const stageId = card.closest('.stage')?.id;
                     if (stageId && gameState.stageResults[stageId]?.completed) return;
                    if (!multi) {
                        cont.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                    } else {
                        card.classList.toggle('selected');
                    }
                }));
            });
        }
        function validateStage2() {
             if(gameState.stageResults.stage2.completed) return;
            const selP = producerCardsContainer.querySelector('.card.selected'); const selO = Array.from(obligationCardsContainer.querySelectorAll('.card.selected')).map(c => c.dataset.card); const correctP = 'exploitant'; const correctO = ['financer', 'adherer', 'eco-concevoir']; let pOk = selP?.dataset.card === correctP; let oOk = selO.length === correctO.length && correctO.every(ob => selO.includes(ob)); gameState.stageResults.stage2.producerCorrect=pOk; gameState.stageResults.stage2.obligationsCorrect=oOk;

            if (pOk && oOk) {
                gameState.stageResults.stage2.keyLetter = 'F';
                stage2Feedback.textContent = `Excellent ! Producteur et obligations identifiés. La première lettre de l'obligation financière est "${gameState.stageResults.stage2.keyLetter}".`;
                stage2Feedback.className = 'feedback success';
                stage2Feedback.style.display = 'block';
                gameState.stageResults.stage2.completed = true;
                document.querySelector('#stage2 .regulatory-info')?.classList.add('visible');
                validateStage2Button.style.display = 'none';
                producerCardsContainer.querySelectorAll('.card').forEach(c => c.style.pointerEvents = 'none');
                obligationCardsContainer.querySelectorAll('.card').forEach(c => c.style.pointerEvents = 'none');
                nextStageContainer2.style.display = 'block';
                // *** ENVOYER UPDATE SHEET ***
                sendUpdateToSheet({ stage2_completed: true });
                nextStageBtn2.disabled = false;
            } else {
                let fb = 'Vérifiez. '; if (!pOk) fb += 'Producteur incorrect. '; if (!oOk) fb += 'Obligations incorrectes/incomplètes.';
                stage2Feedback.textContent = fb; stage2Feedback.className = 'feedback error'; stage2Feedback.style.display = 'block';
            }
        }

        // == Stage 3: Sequential Logistics ==
        function initStage3CardClicks() {
            if (availableLogisticsStepsContainer) {
                availableLogisticsStepsContainer.addEventListener('click', function(event) {
                    const clickedCard = event.target.closest('.card');
                    if (clickedCard && gameState.currentStage === 'stage3' && !gameState.stageResults.stage3.completed) {
                        const stepId = clickedCard.dataset.stepId;
                        if (stepId && !gameState.stageResults.stage3.builtSequence.includes(stepId)) {
                            addStepToSequence(stepId);
                        } else if (stepId) {
                            // console.log(`Étape "${stepId}" déjà dans la séquence.`); // Optionnel
                        }
                    }
                });
            }
        }
        function addStepToSequence(stepId) {
            if (gameState.stageResults.stage3.completed) return;
            gameState.stageResults.stage3.builtSequence.push(stepId);
            const cardElement = availableLogisticsStepsContainer.querySelector(`.card[data-step-id='${stepId}']`);
            if (cardElement) {
                cardElement.classList.add('step-in-sequence');
            }
            updateBuiltSequenceDisplay();
        }
        function removeStepFromSequence(stepId) {
            if (gameState.stageResults.stage3.completed) return;
            gameState.stageResults.stage3.builtSequence = gameState.stageResults.stage3.builtSequence.filter(id => id !== stepId);
            const cardElement = availableLogisticsStepsContainer.querySelector(`.card[data-step-id='${stepId}']`);
            if (cardElement) {
                cardElement.classList.remove('step-in-sequence');
            }
            updateBuiltSequenceDisplay();
        }
        function clearBuiltSequence() {
            if (gameState.stageResults.stage3.completed) return;
            availableLogisticsStepsContainer.querySelectorAll('.card.step-in-sequence').forEach(card => {
                card.classList.remove('step-in-sequence');
            });
            gameState.stageResults.stage3.builtSequence = [];
            updateBuiltSequenceDisplay();
            stage3Feedback.style.display = 'none';
            stage3Feedback.textContent = '';
            stage3Feedback.className = 'feedback';
        }
        function updateBuiltSequenceDisplay() {
            if (!builtSequenceList) return;
            builtSequenceList.innerHTML = '';
            gameState.stageResults.stage3.builtSequence.forEach((stepId) => {
                const listItem = document.createElement('li');
                const card = availableLogisticsStepsContainer.querySelector(`.card[data-step-id='${stepId}']`);
                listItem.textContent = card ? card.textContent : stepId;
                listItem.style.cursor = 'pointer';
                listItem.title = "Cliquez pour retirer cette étape";
                listItem.addEventListener('click', () => removeStepFromSequence(stepId));
                listItem.classList.add('step-selected');
                builtSequenceList.appendChild(listItem);
            });
             if (validateStage3Button) {
                 validateStage3Button.disabled = gameState.stageResults.stage3.builtSequence.length === 0 || gameState.stageResults.stage3.completed;
             }
             if (clearSequenceButton) {
                clearSequenceButton.disabled = gameState.stageResults.stage3.builtSequence.length === 0 || gameState.stageResults.stage3.completed;
             }
        }
        function shuffleAvailableLogisticsSteps() {
            const container = availableLogisticsStepsContainer;
            if (!container) return;
            const cards = Array.from(container.querySelectorAll('.card'));
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
            container.innerHTML = '';
            cards.forEach(card => container.appendChild(card));
            // console.log("Available logistics steps display order shuffled."); // Optionnel
        }
        function validateStage3() {
             if(gameState.stageResults.stage3.completed) return;
            const builtSequence = gameState.stageResults.stage3.builtSequence;
            let sequenceIsCorrect = false;
            if (builtSequence.length === correctLogisticsSequence.length) {
                sequenceIsCorrect = builtSequence.every((step, index) => step === correctLogisticsSequence[index]);
            }
            gameState.stageResults.stage3.sequenceCorrect = sequenceIsCorrect;

            if (sequenceIsCorrect) {
                stage3Feedback.textContent = 'Parfait ! La séquence chronologique est correcte. L\'article L.541-10 du Code de l\'Environnement est central.';
                stage3Feedback.className = 'feedback success';
                stage3Feedback.style.display = 'block';
                gameState.stageResults.stage3.completed = true;
                document.querySelector('#stage3 .regulatory-info')?.classList.add('visible');
                validateStage3Button.disabled = true;
                clearSequenceButton.disabled = true;
                if (availableLogisticsStepsContainer) availableLogisticsStepsContainer.style.pointerEvents = 'none';
                if (builtSequenceList) builtSequenceList.style.pointerEvents = 'none';
                nextStageContainer3.style.display = 'block';
                // *** ENVOYER UPDATE SHEET ***
                sendUpdateToSheet({ stage3_completed: true });
                nextStageBtn3.disabled = false;
            } else {
                let feedbackMessage = "Incorrect. Vérifiez la séquence.";
                stage3Feedback.textContent = feedbackMessage;
                stage3Feedback.className = 'feedback error';
                stage3Feedback.style.display = 'block';
            }
        }

        // == Stage 4: Eco-organisme ==
        function validateStage4() {
             if(gameState.stageResults.stage4.completed) return;
            const tgt=collectionTargetContainer.querySelector('.card.selected'); const nat=ecoOrgNatureContainer.querySelector('.card.selected'); const name=ecoOrgNameInput.value.trim().toUpperCase();
            const correctTgt='70'; const correctNat='non-lucratif'; const correctName='CYCLAMED';
            let tgtOk=tgt?.dataset.target===correctTgt; let natOk=nat?.dataset.nature===correctNat; let nameOk=name===correctName;
            gameState.stageResults.stage4.collectionTarget=tgtOk?correctTgt:''; gameState.stageResults.stage4.ecoOrgNatureCorrect=natOk; gameState.stageResults.stage4.ecoOrgNameCorrect=nameOk;
            gameState.stageResults.stage4.ecoOrgName = (tgtOk && natOk && nameOk) ? correctName : '';

            if(tgtOk && natOk && nameOk){
                stage4Feedback.textContent = `Excellent ! Infos correctes. L'objectif est ${correctTgt}% et l'organisme est ${correctName}.`;
                stage4Feedback.className = 'feedback success'; stage4Feedback.style.display = 'block';
                gameState.stageResults.stage4.completed=true;
                document.querySelector('#stage4 .regulatory-info')?.classList.add('visible');
                 validateStage4Button.style.display = 'none';
                 collectionTargetContainer.querySelectorAll('.card').forEach(c => c.style.pointerEvents = 'none');
                 ecoOrgNatureContainer.querySelectorAll('.card').forEach(c => c.style.pointerEvents = 'none');
                 ecoOrgNameInput.disabled = true;

                if(gameState.stageResults.stage1.correctItemsCount > 0 && gameState.stageResults.stage2.keyLetter){
                    gameState.finalCode=`${gameState.stageResults.stage1.correctItemsCount}${correctTgt}10`;
                    gameState.finalPassword=`${gameState.stageResults.stage2.keyLetter}${correctName}`;
                    console.log("Code Final:", gameState.finalCode, "Mdp:", gameState.finalPassword);
                    updateFinalStageInfoDisplay();
                    nextStageContainer4.style.display = 'block';
                     // *** ENVOYER UPDATE SHEET ***
                     sendUpdateToSheet({ stage4_completed: true });
                    nextStageBtn4.disabled = false;
                } else {
                    console.error("Manque infos E1/E2 pour calcul final.");
                    stage4Feedback.textContent += "\nErreur interne: Impossible de calculer le code final (données E1/E2 manquantes).";
                    stage4Feedback.className = 'feedback error';
                }
            } else {
                let fb='Vérifiez. '; if(!tgtOk) fb+='Objectif incorrect. '; if(!natOk) fb+='Statut incorrect. '; if(!nameOk) fb+='Nom incorrect.';
                stage4Feedback.textContent=fb; stage4Feedback.className='feedback error'; stage4Feedback.style.display='block';
            }
        }

        // == Final Stage: Validation ==
        function validateFinal() {
            const code=finalCodeInput.value.trim(); const pwd=finalPasswordInput.value.trim().toUpperCase();

            if(!gameState.finalCode || !gameState.finalPassword){
                finalFeedback.textContent='Erreur: Codes finaux non générés. Validez les étapes précédentes.';
                finalFeedback.className='feedback error'; finalFeedback.style.display='block';
                // Tentative de recalcul (si skip partiel ou autre souci)
                if (gameState.stageResults.stage1.correctItemsCount > 0 &&
                    gameState.stageResults.stage4.collectionTarget &&
                    gameState.stageResults.stage2.keyLetter &&
                    gameState.stageResults.stage4.ecoOrgName) {
                     gameState.finalCode = `${gameState.stageResults.stage1.correctItemsCount}${gameState.stageResults.stage4.collectionTarget}10`;
                     gameState.finalPassword = `${gameState.stageResults.stage2.keyLetter}${gameState.stageResults.stage4.ecoOrgName}`;
                     updateFinalStageInfoDisplay();
                     finalFeedback.textContent += ' (Codes recalculés, réessayez.)';
                     console.warn("Recalculated final codes on validation attempt.");
                 } else {
                     console.error("Cannot recalculate final codes - missing prerequisite data.");
                 }
                return;
             }

             if(code === gameState.finalCode && pwd === gameState.finalPassword){
                 finalFeedback.textContent='Accès autorisé ! Système restauré !';
                 finalFeedback.className='feedback success'; finalFeedback.style.display='block';
                 clearInterval(gameState.timerInterval);
                 clearInterval(periodicUpdateInterval); // Arrêter la mise à jour périodique

                 const timeE = gameState.totalGameTime - gameState.timeRemaining;
                 const minT = Math.floor(timeE / (60 * 1000));
                 const secT = Math.floor((timeE % (60 * 1000)) / 1000);
                 if(timeTakenDisplay) timeTakenDisplay.textContent=`${minT} min ${secT} sec`;

                 // *** ENVOYER UPDATE SHEET (Succès final) ***
                  // On l'envoie avant le setTimeout pour être sûr qu'elle parte
                  // en cas de fermeture rapide de la fenêtre après la validation.
                  // Utiliser setTimeout pour s'assurer que currentStage est bien mis à jour dans gameState avant l'envoi
                 setTimeout(() => {
                    // Mettre à jour gameState.currentStage avant l'envoi final
                    // Bien que showStage le fasse, le faire ici garantit que l'état envoyé est 'success'
                    // gameState.currentStage = 'success'; // Déjà géré par showStage appelé plus tard, mais peut être forcé ici si besoin
                    sendUpdateToSheet({
                        // Envoyer currentStage comme 'success' explicitement si showStage n'est pas encore appelé
                        currentStage: 'success',
                        status: 'Terminé',
                        finalCodeAttempt: code, // Envoie le code correct
                        finalPasswordAttempt: pwd // Envoie le mdp correct
                    });
                 }, 50); // Petit délai pour laisser le temps aux opérations synchrones


                 setTimeout(() => {
                     teamNameDisplayCert.textContent=gameState.teamName;
                     timeRemainingDisplay.textContent=timerElement.textContent;
                     if (participantListCert) {
                         participantListCert.innerHTML = '';
                         if (gameState.participants.length > 0) {
                             gameState.participants.forEach(name => {
                                 const li = document.createElement('li');
                                 li.textContent = name;
                                 participantListCert.appendChild(li);
                              });
                             document.getElementById('participants-section-cert').style.display = 'block';
                         } else {
                             document.getElementById('participants-section-cert').style.display = 'none';
                         }
                     }
                     showStage('success'); // Afficher l'écran de succès
                 }, 1500);
             } else {
                 finalFeedback.textContent='Accès refusé. Code ou Mot de Passe incorrect.';
                 finalFeedback.className='feedback error'; finalFeedback.style.display='block';
                 // *** ENVOYER UPDATE SHEET (Tentative échouée) ***
                 sendUpdateToSheet({
                     finalCodeAttempt: code,
                     finalPasswordAttempt: pwd,
                     status: 'Tentative finale échouée' // Garder le status "En cours" ou le préciser
                 });
             }
         }

        // --- Game Reset ---
        function resetGame() {
            // Reset core game state
            gameState.teamName=''; gameState.teamId = null; // Important de réinitialiser l'ID
            gameState.participants = []; gameState.startTime=null; gameState.timeRemaining=gameState.totalGameTime;
            clearInterval(gameState.timerInterval);
            clearInterval(periodicUpdateInterval); // Arrêter la mise à jour périodique
            gameState.currentStage='intro';

            gameState.stageResults = {
                stage1: { completed: false, correctItemsCount: 0 },
                stage2: { completed: false, producerCorrect: false, obligationsCorrect: false, keyLetter: '' },
                stage3: { completed: false, builtSequence: [], sequenceCorrect: false },
                stage4: { completed: false, collectionTarget: '', ecoOrgNatureCorrect: false, ecoOrgNameCorrect: false, ecoOrgName: '' }
            };
            gameState.finalCode=''; gameState.finalPassword='';

            // Reset UI elements
            if (introTitleElement) introTitleElement.style.display = '';
            if (teamNameGroup) teamNameGroup.style.display = '';
            if (participantsGroup) participantsGroup.style.display = '';
            if (startGameButton) startGameButton.style.display = '';
            teamNameInput.value=''; participantNamesInput.value = ''; teamNameDisplay.textContent='Équipe: Non définie';
            finalCodeInput.value=''; finalPasswordInput.value=''; ecoOrgNameInput.value='';

            document.querySelectorAll('.feedback').forEach(el=>{
                el.textContent=''; el.style.display='none'; el.className='feedback';
            });
            document.querySelectorAll('.card.selected, .item.selected').forEach(el=>el.classList.remove('selected'));
            if (availableLogisticsStepsContainer) {
                availableLogisticsStepsContainer.querySelectorAll('.card.step-in-sequence').forEach(card => {
                    card.classList.remove('step-in-sequence');
                });
            }
            cyclamedZone.innerHTML=''; excludedZone.innerHTML='';
            clearBuiltSequence();
            shuffleAvailableLogisticsSteps();
            document.querySelectorAll('.regulatory-info').forEach(box => box.classList.remove('visible'));

             [validateStage1Button, validateStage2Button, validateStage3Button, validateStage4Button].forEach(btn => {
                 if(btn){ btn.style.display = 'inline-block'; btn.disabled = false; }
             });
              if (validateStage3Button) validateStage3Button.disabled = true;
              ecoOrgNameInput.disabled = false;
              [producerCardsContainer, obligationCardsContainer, collectionTargetContainer, ecoOrgNatureContainer, availableLogisticsStepsContainer, builtSequenceList].forEach(container => {
                  if (container) {
                      container.style.pointerEvents = 'auto';
                      if (container.querySelectorAll) {
                          container.querySelectorAll('.card').forEach(c => c.style.pointerEvents = 'auto');
                      }
                  }
              });

             [nextStageContainer1, nextStageContainer2, nextStageContainer3, nextStageContainer4].forEach(cont => { if(cont) cont.style.display = 'none'; });
             [nextStageBtn1, nextStageBtn2, nextStageBtn3, nextStageBtn4].forEach(btn => { if(btn){ btn.disabled = true; const textNode = Array.from(btn.childNodes).find(node => node.nodeType === Node.TEXT_NODE); if(textNode) textNode.textContent = "Passer à l'étape suivante"; }});

            if (participantListCert) { participantListCert.innerHTML = ''; document.getElementById('participants-section-cert').style.display = 'none';}
             prevStageButton.style.display = 'none';
             prevStageButton.disabled = true;

            updateFinalStageInfoDisplay();
            resetTimerDisplay();
            updateProgress();
            updateStageDots();

            showStage('intro');
        }

        // --- Certificate Download ---
        function handleDownloadCertificatePDF() {
             const certificateElement = certificateContentElement;
             const originalButtonText = downloadPdfButton.innerHTML;
             const teamName = gameState.teamName.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'equipe';
             const filename = `Certificat-Conformite-MNU-${teamName}.pdf`;

             if (typeof html2canvas === 'undefined' || typeof jspdf === 'undefined') {
                 alert("Erreur: Impossible de charger les librairies nécessaires pour générer le PDF.");
                 return;
             }
             const { jsPDF } = jspdf;

              downloadPdfButton.disabled = true;
              downloadPdfButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';

              html2canvas(certificateElement, {
                  scale: 2,
                  useCORS: true,
                  backgroundColor: '#f8f9fa'
              }).then(canvas => {
                  try {
                      const imgData = canvas.toDataURL('image/png');
                      const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                      const pdfWidth = pdf.internal.pageSize.getWidth();
                      const pdfHeight = pdf.internal.pageSize.getHeight();
                      const canvasWidth = canvas.width;
                      const canvasHeight = canvas.height;
                      const canvasRatio = canvasWidth / canvasHeight;
                      const margin = 15;
                      const usableWidth = pdfWidth - 2 * margin;
                      const usableHeight = pdfHeight - 2 * margin;
                      let imgWidth = usableWidth;
                      let imgHeight = imgWidth / canvasRatio;
                      if (imgHeight > usableHeight) {
                          imgHeight = usableHeight;
                          imgWidth = imgHeight * canvasRatio;
                      }
                      const xPos = margin + (usableWidth - imgWidth) / 2;
                      const yPos = margin + (usableHeight - imgHeight) / 2;

                      pdf.addImage(imgData, 'PNG', xPos, yPos, imgWidth, imgHeight);
                      pdf.save(filename);

                  } catch (error) {
                      console.error("Erreur lors de la génération du PDF:", error);
                      alert("Une erreur est survenue pendant la génération du PDF.");
                  } finally {
                       downloadPdfButton.disabled = false;
                       downloadPdfButton.innerHTML = originalButtonText;
                  }
              }).catch(error => {
                  console.error("Erreur html2canvas:", error);
                  alert("Une erreur est survenue lors de la capture du certificat pour le PDF.");
                  downloadPdfButton.disabled = false;
                  downloadPdfButton.innerHTML = originalButtonText;
              });
        }

        // Initialize on load
        window.addEventListener('load', initGame);

    </script>
</body>
</html>
